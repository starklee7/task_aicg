<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœ€æ±‚ååŒçœ‹æ¿ - CHIMER</title>
    <link rel="stylesheet" href="common-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* æ•´ä½“é¡µé¢å¸ƒå±€ */
        .page-container {
            min-height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  - å›ºå®šä¸æ»šåŠ¨ */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 80px;
            height: 100vh;
            background: #ffffff;
            border-right: 1px solid #e8eaed;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 8px;
            z-index: 200;
            overflow-y: auto;
        }

        .logo {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #4285f4;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .logo-text {
            font-size: 10px;
            color: #666;
            font-weight: 500;
        }

        .nav-item {
            width: 56px;
            height: 56px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #e8f0fe;
            color: #1a73e8;
        }

        .nav-item-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .nav-item-text {
            font-size: 10px;
            color: #666;
            text-align: center;
            line-height: 1.2;
        }

        .nav-item.active .nav-item-text {
            color: #1a73e8;
        }

        /* ä¸»å†…å®¹åŒº - ç‹¬ç«‹æ»šåŠ¨ */
        .main-content {
            margin-left: 80px;
            padding-top: 73px; /* ä¸ºå›ºå®šå¤´éƒ¨é¢„ç•™ç©ºé—´ */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
        }

        /* é¡¶éƒ¨æ ‡é¢˜åŒº - æ•´æ å›ºå®šå¸é¡¶ */
        .header {
            position: fixed;
            top: 0;
            left: 80px; /* ä»å¯¼èˆªæ å³ä¾§å¼€å§‹ */
            right: 0;   /* å»¶ä¼¸åˆ°é¡µé¢å³è¾¹ç¼˜ */
            z-index: 150;
            background: #ffffff;
            padding: 16px 24px;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            height: 73px; /* æ˜ç¡®è®¾ç½®å¤´éƒ¨é«˜åº¦ */
            box-sizing: border-box;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: auto;
        }

        .role-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #dadce0;
        }

        .role-label {
            font-size: 14px;
            color: #5f6368;
            font-weight: 500;
        }

        .role-select {
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            color: #202124;
            cursor: pointer;
            outline: none;
            min-width: 80px;
        }

        .role-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .page-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
        }

        .status-tip {
            background: #fef7f0;
            color: #e37400;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #fdd8b5;
        }

        .new-demand-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .new-demand-btn:hover {
            background: #1557b0;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* å¤ç›˜åŒºåŸŸ */
        .review-section {
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e8eaed;
            overflow: hidden;
        }

        .review-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-title {
            font-size: 16px;
            font-weight: 500;
            color: #202124;
        }

        .apply-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .apply-btn:hover {
            background: #1557b0;
        }

        .review-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1px;
            background: #e8eaed;
        }

        .review-column {
            background: #ffffff;
            padding: 20px;
            min-height: 180px;
        }

        .review-column-title {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 12px;
            text-align: center;
        }

        .review-text {
            font-size: 13px;
            color: #5f6368;
            line-height: 1.6;
            text-align: justify;
        }

        .review-text.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .expand-btn {
            color: #1a73e8;
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 8px;
            padding: 0;
        }

        .expand-btn:hover {
            color: #1557b0;
        }

        /* çœ‹æ¿åŒºåŸŸ */
        .kanban-section {
            flex: 1;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e8eaed;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background: #e8eaed;
            flex: 1;
        }

        .kanban-column {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .kanban-column-header {
            padding: 12px 16px;
            background: #f1f3f4;
            border-bottom: 1px solid #e8eaed;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
        }

        .kanban-column-content {
            flex: 1;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .kanban-card {
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #e8eaed;
            padding: 20px 12px 12px 12px;
            cursor: grab;
            transition: all 0.2s ease;
            position: relative;
        }

        .kanban-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .card-status {
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 8px;
            border-radius: 0 0 4px 4px;
            font-size: 10px;
            color: white;
            font-weight: 500;
        }

        .status-pending { background: #ea4335; }
        .status-designing { background: #fbbc04; }
        .status-delivered { background: #34a853; }
        .status-testing { background: #4285f4; }
        .status-reviewed { background: #9aa0a6; }

        .card-image {
            width: 60px;
            height: 60px;
            background: #f1f3f4;
            border-radius: 4px;
            margin: 16px auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .card-update-time {
            font-size: 11px;
            color: #9aa0a6;
            text-align: center;
        }

        .card-review-id {
            font-size: 10px;
            color: #202124;
            text-align: center;
            font-weight: 500;
            margin-top: 3px;
        }

        .card-review-id .field-label {
            color: #202124;
            font-weight: 600;
        }

        /* å¡ç‰‡å­—æ®µæ ·å¼ */
        .card-field {
            margin: 4px 0;
            font-size: 12px;
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
        }

        .field-label {
            color: #5f6368;
            font-weight: 500;
            min-width: 50px;
            margin-right: 4px;
            flex-shrink: 0;
        }

        .field-value {
            color: #202124;
            word-break: break-word;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å¾…ç¡®è®¤åˆ—ç‰¹æ®Šæ ·å¼ */
        [data-status="pending"] .field-value {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å·²å¤ç›˜åˆ—å­—æ®µå€¼å¯ä»¥æ¢è¡Œ */
        [data-status="reviewed"] .field-value {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .review-id-value {
            color: #34a853;
            font-family: monospace;
            font-weight: 600;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .card-delete-btn {
            background: none;
            border: none;
            color: #ea4335;
            font-size: 11px;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 8px;
            text-decoration: underline;
            width: 100%;
            text-align: center;
        }

        /* å¾…ç¡®è®¤åˆ—åˆ é™¤æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        [data-status="pending"] .card-delete-btn {
            margin-top: 0;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            padding: 6px 4px;
        }

        .card-delete-btn:hover {
            color: #d33b2c;
            background: #fef7f0;
        }

        /* å¡ç‰‡æ“ä½œæŒ‰é’®æ ·å¼ */
        .card-action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            justify-content: center;
        }

        /* å¾…ç¡®è®¤åˆ—æ“ä½œæŒ‰é’®ç‰¹æ®Šæ ·å¼ - 2åˆ—ç­‰å®½ */
        [data-status="pending"] .card-action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        [data-status="pending"] .card-action-btn,
        [data-status="pending"] .card-delete-btn {
            width: 100%;
            text-align: center;
            padding: 6px 4px;
        }

        .card-action-btn {
            background: none;
            border: none;
            color: #1a73e8;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .card-action-btn:hover {
            background: #f1f3ff;
            color: #1557b0;
        }

        .card-edit-btn {
            color: #1a73e8;
        }

        .card-edit-btn:hover {
            background: #f1f3ff;
            color: #1557b0;
        }

        .card-upload-btn {
            color: #1a73e8;
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 8px;
        }

        .card-upload-btn:hover {
            background: #f1f3ff;
            color: #1557b0;
        }

        .card-modify-btn {
            color: #1a73e8;
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 8px;
        }

        .card-modify-btn:hover {
            background: #f1f3ff;
            color: #1557b0;
        }

        .card-modify-design-btn {
            color: #1a73e8;
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 8px;
        }

        .card-modify-design-btn:hover {
            background: #f1f3ff;
            color: #1557b0;
        }



        .review-id {
            font-size: 14px;
            color: #5f6368;
            font-weight: normal;
            margin-left: 8px;
        }

        /* ç›®æ ‡äººç¾¤è¡¨å•æ ·å¼ */
        .target-audience-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .target-audience-selects {
            display: flex;
            gap: 12px;
        }

        .target-audience-selects .form-control {
            flex: 1;
        }

        .target-description {
            resize: vertical;
            min-height: 50px;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #5f6368;
            margin-top: 4px;
        }

        .form-example {
            font-size: 12px;
            color: #5f6368;
            margin-top: 6px;
            font-style: italic;
        }

        .form-example-inline {
            font-size: 12px;
            color: #5f6368;
            font-style: italic;
            font-weight: normal;
            margin-left: 8px;
        }

        /* å‚è€ƒå¤ç›˜IDæ ·å¼ */
        .linked-review-id {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .linked-review-id-title {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .linked-review-id-value {
            font-size: 14px;
            color: #34a853;
            font-weight: 600;
            font-family: monospace;
        }

        .linked-review-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .cancel-reference-btn,
        .restore-reference-btn {
            background: #ea4335;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .cancel-reference-btn:hover {
            background: #c5221f;
        }

        .restore-reference-btn {
            background: #1a73e8;
        }

        .restore-reference-btn:hover {
            background: #1557b0;
        }

        .cancelled-review-state {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .cancelled-review-title {
            font-size: 14px;
            color: #9aa0a6;
            font-weight: 500;
        }

        /* ä¸Šä¼ å‚è€ƒæ ·å¼ */
        .upload-area {
            margin-bottom: 16px;
        }

        .upload-zone {
            border: 2px dashed #dadce0;
            border-radius: 8px;
            padding: 32px 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .upload-zone:hover {
            border-color: #4285f4;
            background: #f8f9ff;
        }

        .upload-zone.drag-over {
            border-color: #4285f4;
            background: #e8f0fe;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 14px;
            color: #202124;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .upload-hint {
            font-size: 12px;
            color: #5f6368;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e8eaed;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-preview-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(234, 67, 53, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .image-preview-item:hover .image-delete-btn {
            opacity: 1;
        }

        .image-delete-btn:hover {
            background: rgba(234, 67, 53, 1);
        }

        .upload-counter {
            font-size: 12px;
            color: #5f6368;
            text-align: right;
            margin-bottom: 8px;
        }

        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            cursor: pointer;
        }

        .image-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #202124;
        }

        .image-modal-close:hover {
            background: white;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .review-content {
                grid-template-columns: 1fr;
            }

            .kanban-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
                padding: 10px 0;
            }

            .main-content {
                margin-left: 60px;
                padding-top: 93px; /* ç§»åŠ¨ç«¯å¤´éƒ¨é«˜åº¦è°ƒæ•´ */
            }

            .header {
                left: 60px; /* é€‚é…çª„å¯¼èˆªæ  */
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                height: 93px; /* ç§»åŠ¨ç«¯å¤´éƒ¨é«˜åº¦ */
            }

            .header-left {
                justify-content: center;
            }

            .header-right {
                justify-content: center;
                margin-left: 0;
            }

            .content-area {
                padding: 16px;
            }

            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
        }

        /* æ‹–æ‹½çŠ¶æ€ */
        .kanban-card.dragging {
            opacity: 0.8;
            transform: rotate(2deg);
        }

        .kanban-column.drag-over {
            background: #e8f0fe;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .kanban-column-content::-webkit-scrollbar {
            width: 4px;
        }

        .kanban-column-content::-webkit-scrollbar-track {
            background: #f1f3f4;
        }

        .kanban-column-content::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 2px;
        }

        .kanban-column-content::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        /* æ–°å¢éœ€æ±‚æŠ½å±‰å¼¹æ¡† */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .drawer-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .demand-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100%;
            background: #ffffff;
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 1001;
        }

        .drawer-overlay.show .demand-drawer {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }

        .drawer-title {
            font-size: 18px;
            font-weight: 500;
            color: #202124;
            margin: 0;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .drawer-close:hover {
            background: #f8f9fa;
            color: #202124;
        }

        .drawer-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: " *";
            color: #ea4335;
        }

        .required-star {
            color: #ea4335;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            color: #202124;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .form-control.error {
            border-color: #ea4335;
        }

        .error-message {
            color: #ea4335;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* å•é€‰æŒ‰é’®ç»„ */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .radio-item:hover {
            background: #f8f9fa;
        }

        .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: #1a73e8;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            font-size: 14px;
            color: #202124;
            flex: 1;
        }

        /* ä»·ä½å¸¦è¾“å…¥ */
        .price-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price-input-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .currency-select {
            width: 70px;
            padding: 12px 8px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
        }

        .price-input {
            flex: 1;
        }

        .price-separator {
            color: #5f6368;
            font-weight: 500;
            font-size: 16px;
        }

        /* æ ‡ç­¾è¾“å…¥ */
        .tag-input-container {
            border: 1px solid #dadce0;
            border-radius: 6px;
            padding: 8px;
            min-height: 44px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            cursor: text;
            background: #ffffff;
            transition: all 0.2s ease;
        }

        .tag-input-container:focus-within {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .tag-item {
            display: flex;
            align-items: center;
            background: #374455;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            gap: 4px;
        }

        .tag-item.review-tag {
            background: #34a853;
            color: white;
        }

        .tag-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
        }

        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
            padding: 4px;
            background: transparent;
        }

        /* å‚è€ƒå¤ç›˜æ ‡ç­¾åŒºåŸŸ */
        .linked-tags {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e8eaed;
        }

        .linked-tags-title {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 8px;
        }

        .linked-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        /* æäº¤åŒºåŸŸ */
        .drawer-footer {
            padding: 20px 24px;
            border-top: 1px solid #e8eaed;
            background: #ffffff;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .btn-primary:hover {
            background: #1557b0;
            border-color: #1557b0;
        }

        .btn-secondary {
            background: #ffffff;
            color: #5f6368;
            border-color: #dadce0;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #bdc1c6;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .demand-drawer {
                width: 100%;
                border-radius: 0;
            }

            .drawer-body {
                padding: 16px;
            }

            .drawer-footer {
                padding: 16px;
                flex-direction: column;
            }

            .price-range {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ“Š</div>
                <div class="logo-text">CHIMER</div>
            </div>

            <div class="nav-item">
                <div class="nav-item-icon">ğŸš€</div>
                <div class="nav-item-text">å¿«é€Ÿç”Ÿæˆ</div>
            </div>

            <div class="nav-item active">
                <div class="nav-item-icon">ğŸ¤</div>
                <div class="nav-item-text">éœ€æ±‚ååŒ</div>
            </div>

            <div class="nav-item">
                <div class="nav-item-icon">ğŸ”¬</div>
                <div class="nav-item-text">å®éªŒå®¤</div>
            </div>

            <div class="nav-item">
                <div class="nav-item-icon">ğŸ“‹</div>
                <div class="nav-item-text">ä¼åˆ’ç‰ˆ</div>
            </div>

            <div class="nav-item">
                <div class="nav-item-icon">â­</div>
                <div class="nav-item-text">æˆ‘çš„æ”¶è—</div>
            </div>

            <div class="nav-item">
                <div class="nav-item-icon">ğŸ¨</div>
                <div class="nav-item-text">ç´ æåº“</div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
            <div class="header">
                <div class="header-left">
                    <h1 class="page-title">éœ€æ±‚ååŒçœ‹æ¿</h1>
                    <span class="status-tip">æ‹–æ‹½å¡ç‰‡å¯å˜æ›´çŠ¶æ€</span>
                </div>
                <div class="header-right">
                    <button class="new-demand-btn" id="newDemandBtn">æ–°å¢éœ€æ±‚</button>
                    <div class="role-selector">
                        <label for="roleSelect" class="role-label">è§’è‰²ï¼š</label>
                        <select id="roleSelect" class="role-select">
                            <option value="client" selected>å®¢æˆ·</option>
                            <option value="designer">è®¾è®¡å¸ˆ</option>
                            <option value="operator">è¿è¥</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- å¤ç›˜åŒºåŸŸ -->
                <div class="review-section">
                    <div class="review-header">
                        <h2 class="review-title">ä¸Šè½®äº¤ä»˜å¤ç›˜</h2>
                        <button class="apply-btn" id="applyBtn">åº”ç”¨è‡³æ–°éœ€æ±‚å‚è€ƒ</button>
                    </div>
                    <div class="review-content">
                        <div class="review-column">
                            <h3 class="review-column-title">å¸‚åœºäº®ç‚¹</h3>
                            <div class="review-text collapsed" id="highlightsText">
                                æœ¬æ¬¡è®¾è®¡åœ¨è‰²å½©æ­é…ä¸Šé‡‡ç”¨äº†å½“ä¸‹æœ€æµè¡Œçš„è«å…°è¿ªè‰²ç³»ï¼Œæ•´ä½“é£æ ¼ç®€çº¦è€Œä¸å¤±ç²¾è‡´ã€‚ç‰ˆå‹è®¾è®¡å……åˆ†è€ƒè™‘äº†äºšæ´²å¥³æ€§çš„èº«æç‰¹ç‚¹ï¼Œè…°çº¿è®¾è®¡æ°åˆ°å¥½å¤„ï¼Œæ—¢ä¿®é¥°äº†èº«å½¢åˆä¿æŒäº†èˆ’é€‚åº¦ã€‚é¢æ–™é€‰æ‹©ä¸Šé‡‡ç”¨äº†é«˜å“è´¨çš„æ£‰éº»æ··çººæè´¨ï¼Œé€æ°”æ€§å¥½ï¼Œé€‚åˆæ˜¥å¤å­£èŠ‚ç©¿ç€ã€‚ç»†èŠ‚å¤„ç†ä¸Šï¼Œæˆ‘ä»¬åœ¨é¢†å£å’Œè¢–å£å¢åŠ äº†ç²¾è‡´çš„åŒ…è¾¹å·¥è‰ºï¼Œæå‡äº†æ•´ä½“çš„å“è´¨æ„Ÿã€‚æ­¤å¤–ï¼Œè€ƒè™‘åˆ°ç°ä»£å¥³æ€§çš„ç©¿æ­éœ€æ±‚ï¼Œè®¾è®¡ä¸­èå…¥äº†å¤šç§æ­é…å¯èƒ½æ€§ï¼Œæ—¢å¯ä»¥å•†åŠ¡æ­£è£…ï¼Œä¹Ÿèƒ½å¤Ÿä¼‘é—²å‡ºè¡—ï¼Œå®ç”¨æ€§å’Œæ—¶å°šæ€§å¹¶é‡ã€‚
                            </div>
                            <button class="expand-btn" onclick="toggleExpand('highlightsText', this)">å±•å¼€</button>
                        </div>
                        <div class="review-column">
                            <h3 class="review-column-title">å¸‚åœºæ•°æ®</h3>
                            <div class="review-text collapsed" id="metricsText">
                                æ ¹æ®ä¸Šçº¿åçš„å¸‚åœºåé¦ˆæ•°æ®æ˜¾ç¤ºï¼Œè¯¥äº§å“åœ¨ç›®æ ‡äººç¾¤ä¸­çš„æ¥å—åº¦è¾¾åˆ°äº†85%ï¼Œè¿œè¶…é¢„æœŸçš„70%ã€‚é”€å”®æ•°æ®æ–¹é¢ï¼Œé¦–å‘ä¸¤å‘¨å†…å”®å‡º1200ä»¶ï¼Œè½¬åŒ–ç‡è¾¾åˆ°äº†12.5%ã€‚ç”¨æˆ·è¯„ä»·æ•´ä½“ç§¯æï¼Œ4.8åˆ†çš„é«˜è¯„åˆ†ä½“ç°äº†äº§å“çš„å¸‚åœºè®¤å¯åº¦ã€‚ä»å¹´é¾„åˆ†å¸ƒæ¥çœ‹ï¼Œ25-35å²å¥³æ€§å æ¯”æœ€é«˜ï¼Œè¾¾åˆ°60%ï¼Œä¸æˆ‘ä»¬çš„ç›®æ ‡äººç¾¤é«˜åº¦å»åˆã€‚åœ°åŸŸåˆ†å¸ƒä¸Šï¼Œä¸€çº¿åŸå¸‚å æ¯”45%ï¼ŒäºŒçº¿åŸå¸‚å æ¯”35%ï¼Œæ˜¾ç¤ºå‡ºè‰¯å¥½çš„å¸‚åœºæ¸—é€åŠ›ã€‚å¤è´­ç‡è¾¾åˆ°äº†30%ï¼Œè¯´æ˜äº§å“çš„ç”¨æˆ·ç²˜æ€§è¾ƒå¼ºã€‚é€šè¿‡ç¤¾äº¤åª’ä½“çš„ä¼ æ’­ï¼Œè·å¾—äº†å¤§é‡çš„ç”¨æˆ·ç”Ÿæˆå†…å®¹ï¼Œè¿›ä¸€æ­¥æ‰©å¤§äº†å“ç‰Œå½±å“åŠ›ã€‚
                            </div>
                            <button class="expand-btn" onclick="toggleExpand('metricsText', this)">å±•å¼€</button>
                        </div>
                        <div class="review-column">
                            <h3 class="review-column-title">é—®é¢˜&æ”¹è¿›</h3>
                            <div class="review-text collapsed" id="improvementsText">
                                è™½ç„¶æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œä½†ä»æœ‰ä¸€äº›éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚é¦–å…ˆï¼Œéƒ¨åˆ†ç”¨æˆ·åé¦ˆå°ºç åå°ï¼Œå»ºè®®åœ¨ä¸‹ä¸€ç‰ˆæœ¬ä¸­è°ƒæ•´å°ºç æ ‡å‡†ï¼Œç‰¹åˆ«æ˜¯èƒ¸å›´å’Œè…°å›´çš„è®¾è®¡ã€‚å…¶æ¬¡ï¼Œé¢œè‰²é€‰æ‹©ç›¸å¯¹æœ‰é™ï¼Œå»ºè®®å¢åŠ æ›´å¤šè‰²å½©é€‰é¡¹ä»¥æ»¡è¶³ä¸åŒç”¨æˆ·çš„éœ€æ±‚ã€‚åŒ…è£…æ–¹é¢ï¼Œæœ‰ç”¨æˆ·æåˆ°åŒ…è£…è¿‡äºç®€å•ï¼Œå»ºè®®æå‡åŒ…è£…çš„è´¨æ„Ÿå’Œè®¾è®¡æ„Ÿã€‚ç‰©æµé…é€ä¸Šï¼Œéƒ¨åˆ†åœ°åŒºçš„é…é€æ—¶é—´è¾ƒé•¿ï¼Œéœ€è¦ä¼˜åŒ–ä¾›åº”é“¾ç®¡ç†ã€‚å®¢æœå“åº”é€Ÿåº¦ä¹Ÿæœ‰å¾…æå‡ï¼Œå»ºè®®å¢åŠ å®¢æœäººå‘˜é…ç½®ã€‚æ­¤å¤–ï¼Œäº§å“è¯´æ˜å’Œæ´—æŠ¤æŒ‡å—éœ€è¦æ›´åŠ è¯¦ç»†ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ä¿å…»äº§å“ã€‚æœ€åï¼Œå»ºè®®åœ¨ä¸‹ä¸€å­£äº§å“ä¸­å¢åŠ æ›´å¤šçš„æ­é…å»ºè®®å’Œç©¿ç€åœºæ™¯å±•ç¤ºã€‚
                            </div>
                            <button class="expand-btn" onclick="toggleExpand('improvementsText', this)">å±•å¼€</button>
                        </div>
                    </div>
                </div>

                <!-- çœ‹æ¿åŒºåŸŸ -->
                <div class="kanban-section">
                    <div class="kanban-board">
                        <!-- å¾…ç¡®è®¤åˆ— -->
                        <div class="kanban-column" data-status="pending">
                            <div class="kanban-column-header">å¾…ç¡®è®¤(2)</div>
                            <div class="kanban-column-content">
                                <div class="kanban-card" draggable="true" data-id="1">
                                    <div class="card-status status-pending">å¾…ç¡®è®¤</div>
                                    <div class="card-field">
                                        <span class="field-label">ç›®æ ‡äººç¾¤:</span>
                                        <span class="field-value">å¥³æ€§ï¼Œ25-35å²ï¼Œä¸€çº¿åŸå¸‚ç™½é¢†</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å“ç±»:</span>
                                        <span class="field-value">ä¸Šè£…:Tæ¤</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">ä»·ä½å¸¦:</span>
                                        <span class="field-value">Â¥199-299</span>
                                    </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 20:30:56</div>
                                    <div class="card-action-buttons">
                                        <button class="card-action-btn card-edit-btn" onclick="editCard('1')">ç¼–è¾‘</button>
                                        <button class="card-delete-btn" onclick="deleteCard('1')">åˆ é™¤</button>
                                    </div>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="2">
                                    <div class="card-status status-pending">å¾…ç¡®è®¤</div>
                                    <div class="card-field">
                                        <span class="field-label">ç›®æ ‡äººç¾¤:</span>
                                        <span class="field-value">å¥³æ€§ï¼Œ18-25å²ï¼Œå­¦ç”Ÿç¾¤ä½“</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å“ç±»:</span>
                                        <span class="field-value">è£™è£…:è¿è¡£è£™</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">ä»·ä½å¸¦:</span>
                                        <span class="field-value">Â¥129-199</span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value">20241215888</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 19:15:32</div>
                                    <div class="card-action-buttons">
                                        <button class="card-action-btn card-edit-btn" onclick="editCard('2')">ç¼–è¾‘</button>
                                        <button class="card-delete-btn" onclick="deleteCard('2')">åˆ é™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è®¾è®¡ä¸­åˆ— -->
                        <div class="kanban-column" data-status="designing">
                            <div class="kanban-column-header">è®¾è®¡ä¸­(2)</div>
                            <div class="kanban-column-content">
                                <div class="kanban-card" draggable="true" data-id="3">
                                    <div class="card-status status-designing">è®¾è®¡ä¸­</div>
                                    <div class="card-image">ğŸ‘š</div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 20:30:56</div>
                                    <button class="card-action-btn card-upload-btn" onclick="uploadDesign('3')">ä¸Šä¼ è®¾è®¡ç¨¿</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="4">
                                    <div class="card-status status-designing">è®¾è®¡ä¸­</div>
                                    <div class="card-image">ğŸ§¥</div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 18:45:21</div>
                                    <button class="card-action-btn card-upload-btn" onclick="uploadDesign('4')">ä¸Šä¼ è®¾è®¡ç¨¿</button>
                                </div>
                            </div>
                        </div>

                        <!-- å·²äº¤ä»˜åˆ— -->
                        <div class="kanban-column" data-status="delivered">
                            <div class="kanban-column-header">å·²äº¤ä»˜(1)</div>
                            <div class="kanban-column-content">
                                <div class="kanban-card" draggable="true" data-id="8">
                                    <div class="card-status status-delivered">å·²äº¤ä»˜</div>
                                    <div class="card-image">ğŸ§£</div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 20:30:56</div>
                                    <button class="card-action-btn card-modify-design-btn" onclick="modifyDesign('8')">ä¿®æ”¹è®¾è®¡ç¨¿</button>
                                </div>
                            </div>
                        </div>

                        <!-- é¢„å”®æµ‹è¯•åˆ— -->
                        <div class="kanban-column" data-status="testing">
                            <div class="kanban-column-header">é¢„å”®æµ‹è¯•(3)</div>
                            <div class="kanban-column-content">
                                <div class="kanban-card" draggable="true" data-id="5">
                                    <div class="card-status status-testing">é¢„å”®æµ‹è¯•</div>
                                    <div class="card-image">ğŸ‘–</div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 20:30:56</div>
                                    <button class="card-action-btn card-upload-btn" onclick="uploadReviewData('5')">ä¸Šä¼ å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="6">
                                    <div class="card-status status-testing">é¢„å”®æµ‹è¯•</div>
                                    <div class="card-image">ğŸ‘œ</div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 17:22:10</div>
                                    <button class="card-action-btn card-upload-btn" onclick="uploadReviewData('6')">ä¸Šä¼ å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="7">
                                    <div class="card-status status-testing">é¢„å”®æµ‹è¯•</div>
                                    <div class="card-image">ğŸ‘ </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 16:08:45</div>
                                    <button class="card-action-btn card-upload-btn" onclick="uploadReviewData('7')">ä¸Šä¼ å¤ç›˜æ•°æ®</button>
                                </div>
                            </div>
                        </div>

                        <!-- å·²å¤ç›˜åˆ— -->
                        <div class="kanban-column" data-status="reviewed">
                            <div class="kanban-column-header">å·²å¤ç›˜(5)</div>
                            <div class="kanban-column-content">
                                <div class="kanban-card" draggable="true" data-id="9" data-review-id="20241215001">
                                    <div class="card-status status-reviewed">å·²å¤ç›˜</div>
                                    <div class="card-image">ğŸ‘˜</div>
                                    <div class="card-field">
                                        <span class="field-label">è®¾è®¡äº®ç‚¹:</span>
                                        <span class="field-value">è«å…°è¿ªè‰²ç³»ï¼Œç®€çº¦ç²¾è‡´</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å¸‚åœºæ•°æ®:</span>
                                        <span class="field-value">è½¬åŒ–ç‡12.5%ï¼Œå¥½è¯„4.8åˆ†</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">é—®é¢˜æ”¹è¿›:</span>
                                        <span class="field-value">å°ºç åå°ï¼Œéœ€è°ƒæ•´æ ‡å‡†</span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value">20241215000</span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å¤ç›˜ID:</span>
                                        <span class="field-value">20241215001</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 20:30:56</div>
                                    <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('9')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="10" data-review-id="20241215002">
                                    <div class="card-status status-reviewed">å·²å¤ç›˜</div>
                                    <div class="card-image">ğŸ‘™</div>
                                    <div class="card-field">
                                        <span class="field-label">è®¾è®¡äº®ç‚¹:</span>
                                        <span class="field-value">ç‰ˆå‹ä¿®èº«ï¼Œç»†èŠ‚ç²¾è‡´</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å¸‚åœºæ•°æ®:</span>
                                        <span class="field-value">å¤è´­ç‡30%ï¼Œé”€é‡1200ä»¶</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">é—®é¢˜æ”¹è¿›:</span>
                                        <span class="field-value">é¢œè‰²é€‰æ‹©æœ‰é™ï¼Œéœ€å¢åŠ </span>
                                    </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å¤ç›˜ID:</span>
                                        <span class="field-value">20241215002</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 15:45:30</div>
                                    <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('10')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="11" data-review-id="20241215003">
                                    <div class="card-status status-reviewed">å·²å¤ç›˜</div>
                                    <div class="card-image">ğŸ©±</div>
                                    <div class="card-field">
                                        <span class="field-label">è®¾è®¡äº®ç‚¹:</span>
                                        <span class="field-value">èˆ’é€‚é€æ°”ï¼Œé€‚åˆå¤å­£</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å¸‚åœºæ•°æ®:</span>
                                        <span class="field-value">ç›®æ ‡äººç¾¤æ¥å—åº¦85%</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">é—®é¢˜æ”¹è¿›:</span>
                                        <span class="field-value">åŒ…è£…ç®€å•ï¼Œéœ€æå‡è´¨æ„Ÿ</span>
                                    </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å¤ç›˜ID:</span>
                                        <span class="field-value">20241215003</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 14:20:15</div>
                                    <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('11')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="12" data-review-id="20241215004">
                                    <div class="card-status status-reviewed">å·²å¤ç›˜</div>
                                    <div class="card-image">ğŸ§¤</div>
                                    <div class="card-field">
                                        <span class="field-label">è®¾è®¡äº®ç‚¹:</span>
                                        <span class="field-value">å¤šåœºæ™¯æ­é…ï¼Œå®ç”¨æ€§å¼º</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å¸‚åœºæ•°æ®:</span>
                                        <span class="field-value">ä¸€çº¿åŸå¸‚å æ¯”45%</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">é—®é¢˜æ”¹è¿›:</span>
                                        <span class="field-value">ç‰©æµé…é€æ—¶é—´é•¿</span>
                                    </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å¤ç›˜ID:</span>
                                        <span class="field-value">20241215004</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 13:10:08</div>
                                    <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('12')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                                </div>
                                <div class="kanban-card" draggable="true" data-id="13" data-review-id="20241215005">
                                    <div class="card-status status-reviewed">å·²å¤ç›˜</div>
                                    <div class="card-image">ğŸ©</div>
                                    <div class="card-field">
                                        <span class="field-label">è®¾è®¡äº®ç‚¹:</span>
                                        <span class="field-value">ç»å…¸æ—¶å°šï¼Œä¸æ˜“è¿‡æ—¶</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">å¸‚åœºæ•°æ®:</span>
                                        <span class="field-value">ç¤¾äº¤åª’ä½“ä¼ æ’­å¹¿æ³›</span>
                                    </div>
                                    <div class="card-field">
                                        <span class="field-label">é—®é¢˜æ”¹è¿›:</span>
                                        <span class="field-value">å®¢æœå“åº”é€Ÿåº¦å¾…æå‡</span>
                                    </div>
                                    <div class="card-review-id" style="display: none;">
                                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                                        <span class="field-value review-id-value"></span>
                                    </div>
                                    <div class="card-review-id">
                                        <span class="field-label">å¤ç›˜ID:</span>
                                        <span class="field-value">20241215005</span>
                                    </div>
                                    <div class="card-update-time">æ›´æ–°: 2025-08-24 12:05:42</div>
                                    <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('13')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢éœ€æ±‚æŠ½å±‰å¼¹æ¡† -->
    <div class="drawer-overlay" id="demandDrawer">
        <div class="demand-drawer">
            <div class="drawer-header">
                <h2 class="drawer-title">æ–°å¢éœ€æ±‚</h2>
                <button class="drawer-close" id="closeDrawer">&times;</button>
            </div>
            <div class="drawer-body">
                <form id="demandForm">
                    <!-- ç›®æ ‡äººç¾¤ -->
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡äººç¾¤ <span class="required-star">*</span> <span class="form-example-inline">ç¤ºä¾‹ï¼šå¥³æ€§ï¼Œ25-35å²ï¼Œä¸€çº¿åŸå¸‚ç™½é¢†</span></label>
                        <div class="target-audience-group">
                            <div class="target-audience-selects">
                                <select id="gender" name="gender" class="form-control">
                                    <option value="">é€‰æ‹©æ€§åˆ«</option>
                                    <option value="å¥³æ€§">å¥³æ€§</option>
                                    <option value="ç”·æ€§">ç”·æ€§</option>
                                    <option value="ä¸é™">ä¸é™</option>
                                </select>
                                <select id="age_range" name="age_range" class="form-control">
                                    <option value="">é€‰æ‹©å¹´é¾„</option>
                                    <option value="18-25å²">18-25å²</option>
                                    <option value="25-35å²">25-35å²</option>
                                    <option value="35-45å²">35-45å²</option>
                                    <option value="45-55å²">45-55å²</option>
                                    <option value="55å²ä»¥ä¸Š">55å²ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <textarea id="target_description" name="target_description" class="form-control target-description" 
                                placeholder="è¯·æè¿°ç›®æ ‡äººç¾¤ç‰¹å¾ï¼ˆå¦‚ï¼šä¸€çº¿åŸå¸‚ç™½é¢†ã€å­¦ç”Ÿç¾¤ä½“ç­‰ï¼‰ï¼Œé™100å­—" 
                                maxlength="100" rows="2"></textarea>
                            <div class="char-count">
                                <span id="target_description_count">0</span>/100
                            </div>
                        </div>
                        <div class="error-message" id="target_audience_error">è¯·å®Œå–„ç›®æ ‡äººç¾¤ä¿¡æ¯</div>
                    </div>

                    <!-- å“ç±» -->
                    <div class="form-group">
                        <label class="form-label required" for="category">å“ç±»</label>
                        <select id="category" name="category" class="form-control">
                            <option value="">è¯·é€‰æ‹©å“ç±»</option>
                            <optgroup label="ä¸Šè£…">
                                <option value="ä¸Šè£…:Tæ¤">Tæ¤</option>
                                <option value="ä¸Šè£…:è¥¿è£…">è¥¿è£…</option>
                                <option value="ä¸Šè£…:å«è¡£">å«è¡£</option>
                                <option value="ä¸Šè£…:è¡¬è¡«">è¡¬è¡«</option>
                                <option value="ä¸Šè£…:æ¯›è¡£">æ¯›è¡£</option>
                                <option value="ä¸Šè£…:èƒŒå¿ƒ">èƒŒå¿ƒ</option>
                            </optgroup>
                            <optgroup label="ä¸‹è£…">
                                <option value="ä¸‹è£…:ç‰›ä»”é•¿è£¤">ç‰›ä»”é•¿è£¤</option>
                                <option value="ä¸‹è£…:è¥¿è£¤">è¥¿è£¤</option>
                                <option value="ä¸‹è£…:ä¼‘é—²é•¿è£¤">ä¼‘é—²é•¿è£¤</option>
                                <option value="ä¸‹è£…:ä¼‘é—²çŸ­è£¤">ä¼‘é—²çŸ­è£¤</option>
                                <option value="ä¸‹è£…:è¿åŠ¨çŸ­è£¤">è¿åŠ¨çŸ­è£¤</option>
                                <option value="ä¸‹è£…:é˜”è…¿è£¤">é˜”è…¿è£¤</option>
                            </optgroup>
                            <optgroup label="è£™è£…">
                                <option value="è£™è£…:è¿è¡£è£™">è¿è¡£è£™</option>
                                <option value="è£™è£…:è¥¿è£…è£™">è¥¿è£…è£™</option>
                                <option value="è£™è£…:åŠèº«è£™">åŠèº«è£™</option>
                                <option value="è£™è£…:ç™¾è¤¶è£™">ç™¾è¤¶è£™</option>
                                <option value="è£™è£…:èƒŒå¿ƒè£™">èƒŒå¿ƒè£™</option>
                            </optgroup>
                        </select>
                        <div class="error-message" id="category_error">è¯·é€‰æ‹©å“ç±»</div>
                    </div>

                    <!-- ä»·ä½å¸¦ -->
                    <div class="form-group">
                        <label class="form-label">ä»·ä½å¸¦</label>
                        <div class="price-range">
                            <div class="price-input-group">
                                <select class="currency-select" id="currency_min">
                                    <option value="Â¥">Â¥</option>
                                    <option value="$">$</option>
                                    <option value="â‚¬">â‚¬</option>
                                </select>
                                <input type="number" id="price_min" name="price_min" class="form-control price-input" placeholder="æœ€ä½ä»·" min="0">
                            </div>
                            <span class="price-separator">ï½</span>
                            <div class="price-input-group">
                                <select class="currency-select" id="currency_max">
                                    <option value="Â¥">Â¥</option>
                                    <option value="$">$</option>
                                    <option value="â‚¬">â‚¬</option>
                                </select>
                                <input type="number" id="price_max" name="price_max" class="form-control price-input" placeholder="æœ€é«˜ä»·" min="0">
                            </div>
                        </div>
                        <div class="error-message" id="price_error">ä»·æ ¼åŒºé—´æœ‰è¯¯ï¼Œæœ€é«˜ä»·åº”å¤§äºæœ€ä½ä»·</div>
                    </div>

                    <!-- çµæ„Ÿè¯ -->
                    <div class="form-group">
                        <label class="form-label">çµæ„Ÿè¯</label>
                        <div class="tag-input-container" id="tagContainer">
                            <input type="text" class="tag-input" id="tagInput" placeholder="è¾“å…¥çµæ„Ÿè¯åæŒ‰Enteræ·»åŠ ">
                        </div>
                        <div class="linked-review-id" id="linkedReviewId" style="display: none;">
                            <!-- æ­£å¸¸å…³è”çŠ¶æ€ -->
                            <div class="linked-review-state" id="linkedState">
                                <div class="linked-review-id-title">å·²å…³è”å‚è€ƒå¤ç›˜IDï¼š</div>
                                <div class="linked-review-content">
                                    <div class="linked-review-id-value" id="linkedReviewIdValue"></div>
                                    <button class="cancel-reference-btn" id="cancelReferenceBtn" onclick="cancelReference(event)">å–æ¶ˆå‚è€ƒ</button>
                                </div>
                            </div>
                            <!-- å–æ¶ˆå…³è”çŠ¶æ€ -->
                            <div class="cancelled-review-state" id="cancelledState" style="display: none;">
                                <div class="cancelled-review-title">å·²å–æ¶ˆå…³è”å‚è€ƒå¤ç›˜ID</div>
                                <button class="restore-reference-btn" id="restoreReferenceBtn" onclick="restoreReference(event)">é‡æ–°å…³è”</button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸Šä¼ å‚è€ƒ -->
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ å‚è€ƒ</label>
                        <div class="upload-area">
                            <input type="file" id="referenceUpload" accept=".png,.jpg,.jpeg" multiple style="display: none;">
                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-icon">ğŸ“</div>
                                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                                <div class="upload-hint">æ”¯æŒPNGã€JPGã€JPEGæ ¼å¼ï¼Œæœ€å¤šä¸Šä¼ 10å¼ </div>
                            </div>
                        </div>
                        <div class="image-preview-container" id="imagePreviewContainer"></div>
                        <div class="upload-counter">
                            <span id="uploadedCount">0</span>/10å¼ 
                        </div>
                        <div class="error-message" id="upload_error">å›¾ç‰‡æ•°é‡è¶…è¿‡é™åˆ¶æˆ–æ ¼å¼ä¸æ”¯æŒ</div>
                    </div>
                </form>
            </div>
            <div class="drawer-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="submitBtn">æäº¤éœ€æ±‚</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal">
        <button class="image-modal-close" id="imageModalClose">Ã—</button>
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
    </div>

    <script>
        // æ‹–æ‹½åŠŸèƒ½
        let draggedCard = null;

        // å…¨å±€å˜é‡
        let currentTags = [];
        let linkedReviewTags = [];
        let isFromApplyButton = false;
        let currentRole = 'client'; // å½“å‰è§’è‰²ï¼šclient/designer/operator

        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== é¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
            
            initDragAndDrop();
            initButtons();
            initDrawer();
            initFormValidation();
            initTagInput();
            initCharCounter();
            sortKanbanCards();
            generateReviewIds();
            displayReviewId();
            
            console.log('åŸºç¡€åŠŸèƒ½åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–è§’è‰²ç®¡ç†...');
            
            // ç›´æ¥åˆå§‹åŒ–è§’è‰²ç®¡ç†ï¼Œä¸ä½¿ç”¨setTimeout
            initRoleManagement();
            
            // åˆå§‹åŒ–å‚è€ƒå¤ç›˜IDæ˜¾ç¤º
            initReferenceReviewIdDisplay();
            
            console.log('=== é¡µé¢åˆå§‹åŒ–å®Œæˆ ===');
        });

        // åˆå§‹åŒ–å‚è€ƒå¤ç›˜IDæ˜¾ç¤º
        function initReferenceReviewIdDisplay() {
            console.log('ğŸ”§ åˆå§‹åŒ–å‚è€ƒå¤ç›˜IDæ˜¾ç¤º');
            
            const allCards = document.querySelectorAll('.kanban-card');
            allCards.forEach((card, index) => {
                const referenceElements = card.querySelectorAll('.card-review-id');
                
                referenceElements.forEach(element => {
                    const label = element.querySelector('.field-label');
                    const value = element.querySelector('.review-id-value');
                    
                    // å¦‚æœè¿™æ˜¯å‚è€ƒå¤ç›˜IDå­—æ®µä¸”æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤º
                    if (label && label.textContent.includes('å‚è€ƒå¤ç›˜ID') && value && value.textContent.trim()) {
                        element.style.display = 'block';
                        console.log(`å¡ç‰‡ ${index + 1} æ˜¾ç¤ºå‚è€ƒå¤ç›˜ID: ${value.textContent.trim()}`);
                    }
                });
            });
            
            console.log('å‚è€ƒå¤ç›˜IDæ˜¾ç¤ºåˆå§‹åŒ–å®Œæˆ');
        }

        function initDragAndDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedCard = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('kanban-column') || e.target.closest('.kanban-column')) {
                const column = e.target.classList.contains('kanban-column') ? e.target : e.target.closest('.kanban-column');
                column.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('kanban-column') || e.target.closest('.kanban-column')) {
                const column = e.target.classList.contains('kanban-column') ? e.target : e.target.closest('.kanban-column');
                column.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const column = e.target.classList.contains('kanban-column') ? e.target : e.target.closest('.kanban-column');
            
            if (column) {
                column.classList.remove('drag-over');
                
                if (draggedCard && column) {
                    const newStatus = column.dataset.status;
                    const currentColumn = draggedCard.closest('.kanban-column');
                    const currentStatus = currentColumn.dataset.status;
                    
                    // ä»…æ”¯æŒæ¨ªå‘æ‹–åŠ¨ï¼ˆè·¨åˆ—ç§»åŠ¨ï¼‰ï¼Œä¸æ”¯æŒåˆ—å†…ç§»åŠ¨
                    if (currentStatus === newStatus) {
                        showNotification('ä¸æ”¯æŒåœ¨åŒåˆ—å†…ç§»åŠ¨å¡ç‰‡', 'error');
                        return;
                    }
                    
                    // è§’è‰²æƒé™æ£€æŸ¥
                    if (!checkDragPermission(currentStatus, newStatus)) {
                        const roleName = getRoleDisplayName(currentRole);
                        showNotification(`${roleName}è§’è‰²æ— æƒé™è¿›è¡Œæ­¤æ“ä½œ`, 'error');
                        return;
                    }
                    
                    // æ‹–åŠ¨åˆ°å…¶ä»–çŠ¶æ€åˆ—æ—¶å¼¹æ¡†ç¡®è®¤
                    const fromStatusText = getStatusText(currentStatus);
                    const toStatusText = getStatusText(newStatus);
                    const confirmMessage = `ç¡®å®šè¦å°†å¡ç‰‡ä»"${fromStatusText}"ç§»åŠ¨åˆ°"${toStatusText}"å—ï¼Ÿ`;
                    
                    if (!confirm(confirmMessage)) {
                        return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸è¿›è¡Œç§»åŠ¨
                    }
                    
                    const cardId = draggedCard.dataset.id;
                    
                    // ç§»åŠ¨å¡ç‰‡åˆ°æ–°åˆ—
                    const content = column.querySelector('.kanban-column-content');
                    content.appendChild(draggedCard);
                    
                    // æ›´æ–°å¡ç‰‡çŠ¶æ€
                    updateCardStatus(draggedCard, newStatus);
                    
                    // å¦‚æœç§»åŠ¨åˆ°å·²å¤ç›˜çŠ¶æ€ï¼Œç”Ÿæˆå¤ç›˜ID
                    if (newStatus === 'reviewed') {
                        generateReviewIdForCard(draggedCard);
                    }
                    
                    // æ›´æ–°æ—¶é—´æˆ³
                    updateCardTimestamp(draggedCard);
                    
                    // é‡æ–°æ’åºæ‰€æœ‰åˆ—çš„å¡ç‰‡
                    sortKanbanCards();
                    
                    // æ›´æ–°åˆ—è®¡æ•°
                    updateColumnCounts();
                    
                    // é‡æ–°åº”ç”¨è§’è‰²æƒé™ï¼Œç¡®ä¿æ–°çŠ¶æ€çš„å¡ç‰‡æ˜¾ç¤ºå¯¹åº”çš„æ“ä½œæŒ‰é’®
                    console.log(`å¡ç‰‡çŠ¶æ€å˜æ›´å®Œæˆï¼Œé‡æ–°åº”ç”¨${getRoleDisplayName(currentRole)}è§’è‰²æƒé™...`);
                    applyRolePermissions(currentRole);
                    console.log(`${getRoleDisplayName(currentRole)}è§’è‰²æƒé™åº”ç”¨å®Œæˆï¼Œæ–°çŠ¶æ€å¡ç‰‡æ“ä½œæŒ‰é’®å·²æ›´æ–°`);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showNotification(`å¡ç‰‡å·²ç§»åŠ¨åˆ° ${getStatusText(newStatus)}`);
                }
            }
        }

        function updateCardStatus(card, status) {
            const statusElement = card.querySelector('.card-status');
            const statusMap = {
                'pending': { text: 'å¾…ç¡®è®¤', class: 'status-pending' },
                'designing': { text: 'è®¾è®¡ä¸­', class: 'status-designing' },
                'delivered': { text: 'å·²äº¤ä»˜', class: 'status-delivered' },
                'testing': { text: 'é¢„å”®æµ‹è¯•', class: 'status-testing' },
                'reviewed': { text: 'å·²å¤ç›˜', class: 'status-reviewed' }
            };
            
            if (statusMap[status]) {
                statusElement.textContent = statusMap[status].text;
                statusElement.className = `card-status ${statusMap[status].class}`;
                
                // ç‰¹æ®Šå¤„ç†ï¼šåœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´æ—¶ï¼Œä¿æŒå‚è€ƒå¤ç›˜IDçš„æ˜¾ç¤º
                const referenceReviewIdElements = card.querySelectorAll('.card-review-id');
                referenceReviewIdElements.forEach(element => {
                    const label = element.querySelector('.field-label');
                    const value = element.querySelector('.review-id-value');
                    
                    // å¦‚æœè¿™æ˜¯å‚è€ƒå¤ç›˜IDå­—æ®µä¸”æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤º
                    if (label && label.textContent.includes('å‚è€ƒå¤ç›˜ID') && value && value.textContent.trim()) {
                        element.style.display = 'block';
                        console.log(`æ˜¾ç¤ºå‚è€ƒå¤ç›˜ID: ${value.textContent.trim()}`);
                    }
                });
                
                // âœ¨ æ–°å¢ï¼šæ ¹æ®æ–°çŠ¶æ€æ›´æ–°æ“ä½œæŒ‰é’®
                updateCardActionButtons(card, status);
            }
        }

        // æ ¹æ®å¡ç‰‡çŠ¶æ€æ›´æ–°æ“ä½œæŒ‰é’®
        function updateCardActionButtons(card, status) {
            console.log(`æ›´æ–°å¡ç‰‡æ“ä½œæŒ‰é’®ï¼ŒçŠ¶æ€: ${status}`);
            
            const cardId = card.dataset.id;
            let actionButtonsHtml = '';
            
            // æ ¹æ®çŠ¶æ€ç”Ÿæˆå¯¹åº”çš„æ“ä½œæŒ‰é’®
            switch(status) {
                case 'pending':
                    actionButtonsHtml = `
                        <div class="card-action-buttons">
                            <button class="card-action-btn card-edit-btn" onclick="editCard('${cardId}')">ç¼–è¾‘</button>
                            <button class="card-delete-btn" onclick="deleteCard('${cardId}')">åˆ é™¤</button>
                        </div>
                    `;
                    break;
                    
                case 'designing':
                    actionButtonsHtml = `
                        <button class="card-action-btn card-upload-btn" onclick="uploadDesign('${cardId}')">ä¸Šä¼ è®¾è®¡ç¨¿</button>
                    `;
                    break;
                    
                case 'delivered':
                    actionButtonsHtml = `
                        <button class="card-action-btn card-modify-design-btn" onclick="modifyDesign('${cardId}')">ä¿®æ”¹è®¾è®¡ç¨¿</button>
                    `;
                    break;
                    
                case 'testing':
                    actionButtonsHtml = `
                        <button class="card-action-btn card-upload-btn" onclick="uploadReviewData('${cardId}')">ä¸Šä¼ å¤ç›˜æ•°æ®</button>
                    `;
                    break;
                    
                case 'reviewed':
                    actionButtonsHtml = `
                        <button class="card-action-btn card-modify-btn" onclick="modifyReviewData('${cardId}')">ä¿®æ”¹å¤ç›˜æ•°æ®</button>
                    `;
                    break;
                    
                default:
                    actionButtonsHtml = '';
            }
            
            // ç§»é™¤ç°æœ‰çš„æ“ä½œæŒ‰é’®
            const existingActionButtons = card.querySelector('.card-action-buttons');
            const existingUploadBtn = card.querySelector('.card-upload-btn');
            const existingModifyBtn = card.querySelector('.card-modify-btn');
            const existingModifyDesignBtn = card.querySelector('.card-modify-design-btn');
            const existingDeleteBtn = card.querySelector('.card-delete-btn');
            
            if (existingActionButtons) existingActionButtons.remove();
            if (existingUploadBtn) existingUploadBtn.remove();
            if (existingModifyBtn) existingModifyBtn.remove();
            if (existingModifyDesignBtn) existingModifyDesignBtn.remove();
            if (existingDeleteBtn && status !== 'pending') existingDeleteBtn.remove();
            
            // æ·»åŠ æ–°çš„æ“ä½œæŒ‰é’®ï¼ˆåœ¨æ›´æ–°æ—¶é—´ä¹‹åï¼‰
            if (actionButtonsHtml) {
                const updateTimeElement = card.querySelector('.card-update-time');
                if (updateTimeElement) {
                    updateTimeElement.insertAdjacentHTML('afterend', actionButtonsHtml);
                } else {
                    // å¦‚æœæ²¡æœ‰æ›´æ–°æ—¶é—´å…ƒç´ ï¼Œæ·»åŠ åˆ°å¡ç‰‡æœ«å°¾
                    card.insertAdjacentHTML('beforeend', actionButtonsHtml);
                }
                console.log(`å·²æ·»åŠ ${status}çŠ¶æ€çš„æ“ä½œæŒ‰é’®`);
            } else {
                console.log(`${status}çŠ¶æ€æ— éœ€æ·»åŠ æ“ä½œæŒ‰é’®`);
            }
        }

        function updateColumnCounts() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                const cards = column.querySelectorAll('.kanban-card');
                const header = column.querySelector('.kanban-column-header');
                const status = column.dataset.status;
                const statusNames = {
                    'pending': 'å¾…ç¡®è®¤',
                    'designing': 'è®¾è®¡ä¸­',
                    'delivered': 'å·²äº¤ä»˜',
                    'testing': 'é¢„å”®æµ‹è¯•',
                    'reviewed': 'å·²å¤ç›˜'
                };
                header.textContent = `${statusNames[status]}(${cards.length})`;
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¡®è®¤',
                'designing': 'è®¾è®¡ä¸­',
                'delivered': 'å·²äº¤ä»˜',
                'testing': 'é¢„å”®æµ‹è¯•',
                'reviewed': 'å·²å¤ç›˜'
            };
            return statusMap[status] || status;
        }

        function initButtons() {
            // æ–°å¢éœ€æ±‚æŒ‰é’®
            document.getElementById('newDemandBtn').addEventListener('click', function() {
                if (!hasPermission('newDemand')) {
                    const roleName = getRoleDisplayName(currentRole);
                    showNotification(`${roleName}è§’è‰²æ— æƒé™æ–°å¢éœ€æ±‚`, 'error');
                    return;
                }
                isFromApplyButton = false;
                openDrawer();
            });

            // åº”ç”¨æŒ‰é’®
            document.getElementById('applyBtn').addEventListener('click', function() {
                if (!hasPermission('applyReference')) {
                    const roleName = getRoleDisplayName(currentRole);
                    showNotification(`${roleName}è§’è‰²æ— æƒé™åº”ç”¨å¤ç›˜å‚è€ƒ`, 'error');
                    return;
                }
                isFromApplyButton = true;
                applyReviewData();
                openDrawer();
            });
        }

        // å¼¹æ¡†æ§åˆ¶
        function initDrawer() {
            const drawer = document.getElementById('demandDrawer');
            const closeBtn = document.getElementById('closeDrawer');
            const cancelBtn = document.getElementById('cancelBtn');
            const submitBtn = document.getElementById('submitBtn');

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', closeDrawer);
            cancelBtn.addEventListener('click', closeDrawer);

            // ç‚¹å‡»é®ç½©å…³é—­
            drawer.addEventListener('click', function(e) {
                if (e.target === drawer) {
                    closeDrawer();
                }
            });

            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && drawer.classList.contains('show')) {
                    closeDrawer();
                }
            });

            // æäº¤æŒ‰é’®
            submitBtn.addEventListener('click', submitForm);
        }

        function openDrawer() {
            const drawer = document.getElementById('demandDrawer');
            drawer.classList.add('show');
            document.body.style.overflow = 'hidden';

            // å¦‚æœä¸æ˜¯ä»åº”ç”¨æŒ‰é’®è¿›å…¥ï¼Œé‡ç½®è¡¨å•
            if (!isFromApplyButton) {
                resetForm();
            }
        }

        function closeDrawer() {
            const drawer = document.getElementById('demandDrawer');
            drawer.classList.remove('show');
            document.body.style.overflow = '';
            
            // é‡ç½®çŠ¶æ€
            setTimeout(() => {
                resetForm();
                isFromApplyButton = false;
            }, 300);
        }

        function resetForm() {
            // é‡ç½®è¡¨å•
            document.getElementById('demandForm').reset();
            
            // æ¸…ç©ºæ ‡ç­¾
            currentTags = [];
            linkedReviewTags = [];
            
            // é‡ç½®æ ‡ç­¾å®¹å™¨
            const tagContainer = document.getElementById('tagContainer');
            tagContainer.innerHTML = '<input type="text" class="tag-input" id="tagInput" placeholder="è¾“å…¥çµæ„Ÿè¯åæŒ‰Enteræ·»åŠ ">';
            
            // éšè—å‚è€ƒå¤ç›˜IDåŒºåŸŸå¹¶é‡ç½®çŠ¶æ€
            const linkedReviewIdElement = document.getElementById('linkedReviewId');
            const linkedState = document.getElementById('linkedState');
            const cancelledState = document.getElementById('cancelledState');
            
            linkedReviewIdElement.style.display = 'none';
            if (linkedState) {
                linkedState.style.display = 'block';
            }
            if (cancelledState) {
                cancelledState.style.display = 'none';
            }
            
            // æ¸…ç©ºä¿å­˜çš„å‚è€ƒå¤ç›˜ID
            savedReferenceId = '';
            
            // æ¸…é™¤é”™è¯¯çŠ¶æ€
            clearFormErrors();
            
            // é‡æ–°åˆå§‹åŒ–æ ‡ç­¾è¾“å…¥
            initTagInput();
        }

        function applyReviewData() {
            // è·å–æœ€æ–°çš„å¤ç›˜ID
            const latestReviewedCard = document.querySelector('[data-status="reviewed"] .kanban-card');
            if (latestReviewedCard && latestReviewedCard.dataset.reviewId) {
                const reviewId = latestReviewedCard.dataset.reviewId;
                
                // æ˜¾ç¤ºå‚è€ƒå¤ç›˜IDåŒºåŸŸ
                const linkedReviewIdElement = document.getElementById('linkedReviewId');
                const linkedReviewIdValue = document.getElementById('linkedReviewIdValue');
                const linkedState = document.getElementById('linkedState');
                const cancelledState = document.getElementById('cancelledState');
                
                // ä¿å­˜å‚è€ƒå¤ç›˜ID
                savedReferenceId = reviewId;
                
                // æ˜¾ç¤ºæ•´ä¸ªå‚è€ƒå¤ç›˜IDå®¹å™¨
                linkedReviewIdElement.style.display = 'block';
                
                // è®¾ç½®å‚è€ƒå¤ç›˜IDå€¼
                linkedReviewIdValue.textContent = reviewId;
                
                // æ˜¾ç¤ºæ­£å¸¸å…³è”çŠ¶æ€ï¼Œéšè—å–æ¶ˆå…³è”çŠ¶æ€
                if (linkedState) {
                    linkedState.style.display = 'block';
                }
                if (cancelledState) {
                    cancelledState.style.display = 'none';
                }
            }
        }



        // æ ‡ç­¾è¾“å…¥åŠŸèƒ½
        function initTagInput() {
            const tagInput = document.getElementById('tagInput');
            if (!tagInput) return;
            
            const tagContainer = document.getElementById('tagContainer');
            
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tagText = this.value.trim();
                    if (tagText && !currentTags.includes(tagText)) {
                        currentTags.push(tagText);
                        const tagElement = createTagElement(tagText, false, true);
                        tagContainer.insertBefore(tagElement, tagInput);
                        this.value = '';
                    }
                }
            });
        }

        function createTagElement(tagText, isReviewTag = false, removable = true) {
            const tagElement = document.createElement('div');
            tagElement.className = isReviewTag ? 'tag-item review-tag' : 'tag-item';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = tagText;
            tagElement.appendChild(textSpan);
            
            if (removable) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'tag-remove';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.type = 'button';
                removeBtn.onclick = function() {
                    if (isReviewTag) {
                        linkedReviewTags = linkedReviewTags.filter(tag => tag !== tagText);
                        if (linkedReviewTags.length === 0) {
                            document.getElementById('linkedTags').style.display = 'none';
                        }
                    } else {
                        currentTags = currentTags.filter(tag => tag !== tagText);
                    }
                    tagElement.remove();
                };
                tagElement.appendChild(removeBtn);
            }
            
            return tagElement;
        }

        // è¡¨å•éªŒè¯
        function initFormValidation() {
            const form = document.getElementById('demandForm');
            const inputs = form.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                input.addEventListener('blur', validateField);
                input.addEventListener('change', validateField);
            });
        }

        function validateField(e) {
            const field = e.target;
            const fieldName = field.name || field.id;
            let isValid = true;
            let errorMessage = '';
            
            switch (fieldName) {
                case 'target_audience':
                    const selectedRadio = document.querySelector('input[name="target_audience"]:checked');
                    isValid = selectedRadio !== null;
                    errorMessage = 'è¯·é€‰æ‹©ç›®æ ‡äººç¾¤';
                    break;
                case 'category':
                    isValid = field.value.trim().length > 0;
                    errorMessage = 'è¯·é€‰æ‹©å“ç±»';
                    break;
                case 'price_min':
                case 'price_max':
                    const minPrice = parseFloat(document.getElementById('price_min').value) || 0;
                    const maxPrice = parseFloat(document.getElementById('price_max').value) || 0;
                    if (minPrice > 0 && maxPrice > 0) {
                        isValid = maxPrice >= minPrice;
                        errorMessage = 'ä»·æ ¼åŒºé—´æœ‰è¯¯ï¼Œæœ€é«˜ä»·åº”å¤§äºç­‰äºæœ€ä½ä»·';
                    }
                    break;
            }
            
            const errorElement = document.getElementById(fieldName + '_error');
            if (errorElement) {
                if (isValid) {
                    field.classList.remove('error');
                    errorElement.classList.remove('show');
                } else {
                    field.classList.add('error');
                    errorElement.textContent = errorMessage;
                    errorElement.classList.add('show');
                }
            }
            
            return isValid;
        }

        function validateForm() {
            let isValid = true;
            
            // éªŒè¯ç›®æ ‡äººç¾¤
            const gender = document.getElementById('gender').value;
            const ageRange = document.getElementById('age_range').value;
            const targetDescription = document.getElementById('target_description').value.trim();
            
            if (!gender || !ageRange) {
                isValid = false;
                const errorElement = document.getElementById('target_audience_error');
                errorElement.textContent = 'è¯·é€‰æ‹©æ€§åˆ«å’Œå¹´é¾„èŒƒå›´';
                errorElement.classList.add('show');
            }
            
            // éªŒè¯å“ç±»
            const category = document.getElementById('category');
            if (!category.value.trim()) {
                isValid = false;
                category.classList.add('error');
                const errorElement = document.getElementById('category_error');
                errorElement.textContent = 'è¯·é€‰æ‹©å“ç±»';
                errorElement.classList.add('show');
            }
            
            // éªŒè¯ä»·æ ¼åŒºé—´
            const minPrice = parseFloat(document.getElementById('price_min').value) || 0;
            const maxPrice = parseFloat(document.getElementById('price_max').value) || 0;
            if (minPrice > 0 && maxPrice > 0 && maxPrice < minPrice) {
                isValid = false;
                const errorElement = document.getElementById('price_error');
                errorElement.textContent = 'ä»·æ ¼åŒºé—´æœ‰è¯¯ï¼Œæœ€é«˜ä»·åº”å¤§äºç­‰äºæœ€ä½ä»·';
                errorElement.classList.add('show');
            }
            
            return isValid;
        }

        function clearFormErrors() {
            const errorMessages = document.querySelectorAll('.error-message');
            const errorFields = document.querySelectorAll('.form-control.error');
            
            errorMessages.forEach(error => error.classList.remove('show'));
            errorFields.forEach(field => field.classList.remove('error'));
        }

        function submitForm() {
            clearFormErrors();
            
            if (!validateForm()) {
                showNotification('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const gender = document.getElementById('gender').value;
            const ageRange = document.getElementById('age_range').value;
            const targetDescription = document.getElementById('target_description').value.trim();
            
            // ç»„åˆç›®æ ‡äººç¾¤ä¿¡æ¯
            let targetAudience = `${gender}ï¼Œ${ageRange}`;
            if (targetDescription) {
                targetAudience += `ï¼Œ${targetDescription}`;
            }
            
            const formData = {
                gender: gender,
                ageRange: ageRange,
                targetDescription: targetDescription,
                targetAudience: targetAudience,
                category: document.getElementById('category').value,
                priceMin: document.getElementById('price_min').value,
                priceMax: document.getElementById('price_max').value,
                currencyMin: document.getElementById('currency_min').value,
                currencyMax: document.getElementById('currency_max').value,
                tags: [...currentTags]
            };
            
            // æ¨¡æ‹Ÿæäº¤æˆåŠŸ
            showNotification('éœ€æ±‚æäº¤æˆåŠŸï¼æ–°å¡ç‰‡å·²æ·»åŠ åˆ°çœ‹æ¿', 'success');
            
            // å…³é—­å¼¹æ¡†
            closeDrawer();
            
            // æ¨¡æ‹Ÿæ·»åŠ æ–°å¡ç‰‡åˆ°çœ‹æ¿
            addNewDemandCard(formData);
        }

        function addNewDemandCard(formData) {
            const pendingColumn = document.getElementById('pending-column') || 
                                  document.querySelector('[data-status="pending"] .kanban-column-content');
            
            if (pendingColumn) {
                // ç§»é™¤å ä½ç¬¦
                const placeholder = pendingColumn.querySelector('.empty-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // åˆ›å»ºæ–°å¡ç‰‡
                const newCard = document.createElement('div');
                newCard.className = 'kanban-card';
                newCard.draggable = true;
                newCard.dataset.id = 'NEW_' + Date.now();
                
                const priceText = formData.priceMin && formData.priceMax ? 
                    `${formData.currencyMin}${formData.priceMin}-${formData.currencyMax}${formData.priceMax}` : 'æœªè®¾ç½®';
                
                const now = new Date();
                const timeString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å‚è€ƒå¤ç›˜IDï¼ˆä»åº”ç”¨æŒ‰é’®è¿›å…¥æ—¶ï¼‰
                const reviewIdSection = isFromApplyButton ? `
                    <div class="card-review-id">
                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                        <span class="field-value review-id-value">${getCurrentReviewId()}</span>
                    </div>
                ` : `
                    <div class="card-review-id" style="display: none;">
                        <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                        <span class="field-value review-id-value"></span>
                    </div>
                `;
                
                newCard.innerHTML = `
                    <div class="card-status status-pending">å¾…ç¡®è®¤</div>
                    <div class="card-field">
                        <span class="field-label">ç›®æ ‡äººç¾¤:</span>
                        <span class="field-value">${formData.targetAudience || 'æœªè®¾ç½®'}</span>
                    </div>
                    <div class="card-field">
                        <span class="field-label">å“ç±»:</span>
                        <span class="field-value">${formData.category || 'æœªè®¾ç½®'}</span>
                    </div>
                    <div class="card-field">
                        <span class="field-label">ä»·ä½å¸¦:</span>
                        <span class="field-value">${priceText}</span>
                    </div>
                    ${reviewIdSection}
                    <div class="card-update-time">æ›´æ–°: ${timeString}</div>
                    <div class="card-action-buttons">
                        <button class="card-action-btn card-edit-btn" onclick="editCard('${newCard.dataset.id}')">ç¼–è¾‘</button>
                        <button class="card-delete-btn" onclick="deleteCard('${newCard.dataset.id}')">åˆ é™¤</button>
                    </div>
                `;
                
                pendingColumn.appendChild(newCard);
                
                // æŒ‰æ—¶é—´æ’åº
                sortKanbanCards();
                
                // æ›´æ–°åˆ—è®¡æ•°
                updateColumnCounts();
                
                // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                initDragAndDrop();
                
                // åº”ç”¨å½“å‰è§’è‰²æƒé™åˆ°æ–°å¡ç‰‡
                applyRolePermissions(currentRole);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#ea4335' : '#1a73e8';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 2000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInTop 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutTop 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // å±•å¼€/æ”¶èµ·åŠŸèƒ½
        function toggleExpand(textId, button) {
            const textElement = document.getElementById(textId);
            const isCollapsed = textElement.classList.contains('collapsed');
            
            if (isCollapsed) {
                textElement.classList.remove('collapsed');
                button.textContent = 'æ”¶èµ·';
            } else {
                textElement.classList.add('collapsed');
                button.textContent = 'å±•å¼€';
            }
        }

        // æŒ‰æ—¶é—´æ’åºçœ‹æ¿å¡ç‰‡
        function sortKanbanCards() {
            const columns = document.querySelectorAll('.kanban-column');
            
            columns.forEach(column => {
                const columnContent = column.querySelector('.kanban-column-content');
                const cards = Array.from(columnContent.querySelectorAll('.kanban-card'));
                
                // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆä»æ™šåˆ°æ—©ï¼‰
                cards.sort((a, b) => {
                    const timeA = a.querySelector('.card-update-time').textContent.replace('æ›´æ–°: ', '');
                    const timeB = b.querySelector('.card-update-time').textContent.replace('æ›´æ–°: ', '');
                    return new Date(timeB) - new Date(timeA);
                });
                
                // é‡æ–°æ’åˆ—å¡ç‰‡
                cards.forEach(card => {
                    columnContent.appendChild(card);
                });
            });
        }

        // ç”Ÿæˆå¤ç›˜ID
        function generateReviewId() {
            const now = new Date();
            const year = now.getFullYear().toString();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `${year}${month}${day}${randomNum}`;
        }

        // ä¸ºå·²å¤ç›˜å¡ç‰‡ç”Ÿæˆå¤ç›˜ID
        function generateReviewIds() {
            const reviewedCards = document.querySelectorAll('[data-status="reviewed"] .kanban-card');
            
            reviewedCards.forEach(card => {
                if (!card.dataset.reviewId) {
                    const reviewId = generateReviewId();
                    card.dataset.reviewId = reviewId;
                    
                    // åœ¨å¡ç‰‡ä¸­æ·»åŠ å¤ç›˜IDæ˜¾ç¤º
                    const updateTimeElement = card.querySelector('.card-update-time');
                    if (updateTimeElement) {
                        const reviewIdElement = document.createElement('div');
                        reviewIdElement.className = 'card-review-id';
                        reviewIdElement.textContent = `å¤ç›˜ID: ${reviewId}`;
                        updateTimeElement.insertAdjacentElement('afterend', reviewIdElement);
                    }
                }
            });
        }

        // åœ¨å¤ç›˜åŒºåŸŸæ˜¾ç¤ºå¤ç›˜ID
        function displayReviewId() {
            const reviewTitle = document.querySelector('.review-title');
            if (reviewTitle && !reviewTitle.querySelector('.review-id')) {
                // è·å–æœ€æ–°çš„å¤ç›˜IDï¼ˆå–å·²å¤ç›˜å¡ç‰‡ä¸­çš„ç¬¬ä¸€ä¸ªï¼‰
                const latestReviewedCard = document.querySelector('[data-status="reviewed"] .kanban-card');
                if (latestReviewedCard && latestReviewedCard.dataset.reviewId) {
                    const reviewIdSpan = document.createElement('span');
                    reviewIdSpan.className = 'review-id';
                    reviewIdSpan.textContent = `(ID: ${latestReviewedCard.dataset.reviewId})`;
                    reviewTitle.appendChild(reviewIdSpan);
                }
            }
        }

        // ä¸ºå•ä¸ªå¡ç‰‡ç”Ÿæˆå¤ç›˜ID
        function generateReviewIdForCard(card) {
            if (!card.dataset.reviewId) {
                const reviewId = generateReviewId();
                card.dataset.reviewId = reviewId;
                
                // åœ¨å¡ç‰‡ä¸­æ·»åŠ å¤ç›˜IDæ˜¾ç¤º
                const updateTimeElement = card.querySelector('.card-update-time');
                if (updateTimeElement) {
                    // å¦‚æœå·²ç»æœ‰å¤ç›˜IDæ˜¾ç¤ºï¼Œå…ˆç§»é™¤ï¼ˆåªç§»é™¤å¤ç›˜IDï¼Œä¸ç§»é™¤å‚è€ƒå¤ç›˜IDï¼‰
                    const existingReviewIdElements = card.querySelectorAll('.card-review-id');
                    existingReviewIdElements.forEach(element => {
                        const label = element.querySelector('.field-label');
                        // åªç§»é™¤"å¤ç›˜ID"å­—æ®µï¼Œä¿ç•™"å‚è€ƒå¤ç›˜ID"å­—æ®µ
                        if (label && label.textContent.includes('å¤ç›˜ID:') && !label.textContent.includes('å‚è€ƒå¤ç›˜ID')) {
                            element.remove();
                        }
                    });
                    
                    const reviewIdElement = document.createElement('div');
                    reviewIdElement.className = 'card-review-id';
                    reviewIdElement.innerHTML = `
                        <span class="field-label">å¤ç›˜ID:</span>
                        <span class="field-value">${reviewId}</span>
                    `;
                    updateTimeElement.insertAdjacentElement('afterend', reviewIdElement);
                }
                
                // æ›´æ–°å¤ç›˜åŒºåŸŸçš„IDæ˜¾ç¤º
                updateReviewAreaId(reviewId);
            }
        }

        // æ›´æ–°å¡ç‰‡æ—¶é—´æˆ³
        function updateCardTimestamp(card) {
            const updateTimeElement = card.querySelector('.card-update-time');
            if (updateTimeElement) {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                
                updateTimeElement.textContent = `æ›´æ–°: ${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
        }

        // æ›´æ–°å¤ç›˜åŒºåŸŸIDæ˜¾ç¤º
        function updateReviewAreaId(reviewId) {
            const reviewTitle = document.querySelector('.review-title');
            const existingReviewId = reviewTitle.querySelector('.review-id');
            
            if (existingReviewId) {
                existingReviewId.textContent = `(ID: ${reviewId})`;
            } else {
                const reviewIdSpan = document.createElement('span');
                reviewIdSpan.className = 'review-id';
                reviewIdSpan.textContent = `(ID: ${reviewId})`;
                reviewTitle.appendChild(reviewIdSpan);
            }
        }

        // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°å™¨
        function initCharCounter() {
            const targetDescription = document.getElementById('target_description');
            const charCount = document.getElementById('target_description_count');
            
            if (targetDescription && charCount) {
                targetDescription.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    charCount.textContent = currentLength;
                    
                    // æ¥è¿‘é™åˆ¶æ—¶æ”¹å˜é¢œè‰²
                    if (currentLength > 80) {
                        charCount.style.color = '#ea4335';
                    } else if (currentLength > 60) {
                        charCount.style.color = '#f9ab00';
                    } else {
                        charCount.style.color = '#5f6368';
                    }
                });
            }
        }

        // åˆ é™¤å¡ç‰‡
        function deleteCard(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('delete', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™åˆ é™¤æ­¤å¡ç‰‡`, 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿ')) {
                if (card) {
                    card.remove();
                    updateColumnCounts();
                    showNotification('å¡ç‰‡å·²åˆ é™¤', 'success');
                }
            }
        }

        // ç¼–è¾‘å¡ç‰‡ï¼ˆå¾…ç¡®è®¤åˆ—ï¼‰
        function editCard(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('edit', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™ç¼–è¾‘æ­¤å¡ç‰‡`, 'error');
                return;
            }
            
            showNotification(`ç¼–è¾‘å¡ç‰‡ ID: ${cardId}`, 'info');
            // TODO: å®ç°ç¼–è¾‘å¡ç‰‡åŠŸèƒ½
            console.log('ç¼–è¾‘å¡ç‰‡:', cardId);
        }

        // ä¸Šä¼ è®¾è®¡ç¨¿ï¼ˆè®¾è®¡ä¸­åˆ—ï¼‰
        function uploadDesign(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('uploadDesign', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™ä¸Šä¼ è®¾è®¡ç¨¿`, 'error');
                return;
            }
            
            showNotification(`ä¸Šä¼ è®¾è®¡ç¨¿ ID: ${cardId}`, 'info');
            // TODO: å®ç°ä¸Šä¼ è®¾è®¡ç¨¿åŠŸèƒ½
            console.log('ä¸Šä¼ è®¾è®¡ç¨¿:', cardId);
        }

        // ä¿®æ”¹è®¾è®¡ç¨¿ï¼ˆå·²äº¤ä»˜åˆ—ï¼‰
        function modifyDesign(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('modifyDesign', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™ä¿®æ”¹è®¾è®¡ç¨¿`, 'error');
                return;
            }
            
            showNotification(`ä¿®æ”¹è®¾è®¡ç¨¿ ID: ${cardId}`, 'info');
            // TODO: å®ç°ä¿®æ”¹è®¾è®¡ç¨¿åŠŸèƒ½
            console.log('ä¿®æ”¹è®¾è®¡ç¨¿:', cardId);
        }

        // ä¸Šä¼ å¤ç›˜æ•°æ®ï¼ˆé¢„å”®æµ‹è¯•åˆ—ï¼‰
        function uploadReviewData(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('uploadReviewData', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™ä¸Šä¼ å¤ç›˜æ•°æ®`, 'error');
                return;
            }
            
            showNotification(`ä¸Šä¼ å¤ç›˜æ•°æ® ID: ${cardId}`, 'info');
            // TODO: å®ç°ä¸Šä¼ å¤ç›˜æ•°æ®åŠŸèƒ½
            console.log('ä¸Šä¼ å¤ç›˜æ•°æ®:', cardId);
        }

        // ä¿®æ”¹å¤ç›˜æ•°æ®ï¼ˆå·²å¤ç›˜åˆ—ï¼‰
        function modifyReviewData(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            const cardStatus = card ? card.closest('.kanban-column').dataset.status : null;
            
            if (!checkButtonPermission('modifyReviewData', cardStatus)) {
                const roleName = getRoleDisplayName(currentRole);
                showNotification(`${roleName}è§’è‰²æ— æƒé™ä¿®æ”¹å¤ç›˜æ•°æ®`, 'error');
                return;
            }
            
            showNotification(`ä¿®æ”¹å¤ç›˜æ•°æ® ID: ${cardId}`, 'info');
            // TODO: å®ç°ä¿®æ”¹å¤ç›˜æ•°æ®åŠŸèƒ½
            console.log('ä¿®æ”¹å¤ç›˜æ•°æ®:', cardId);
        }

        // è·å–å½“å‰æœ€æ–°å¤ç›˜ID
        function getCurrentReviewId() {
            const latestReviewedCard = document.querySelector('[data-status="reviewed"] .kanban-card');
            return latestReviewedCard && latestReviewedCard.dataset.reviewId ? 
                   latestReviewedCard.dataset.reviewId : '20241215001';
        }

        // å–æ¶ˆå‚è€ƒå¤ç›˜IDå…³è”
        let savedReferenceId = ''; // ä¿å­˜è¢«å–æ¶ˆçš„å‚è€ƒå¤ç›˜IDï¼Œç”¨äºæ¢å¤
        
        function cancelReference(event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¼¹æ¡†å…³é—­
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log('å–æ¶ˆå‚è€ƒå¤ç›˜IDå…³è”');
            
            // ä¿å­˜å½“å‰çš„å‚è€ƒå¤ç›˜IDä»¥ä¾¿æ¢å¤
            const linkedReviewIdValue = document.getElementById('linkedReviewIdValue');
            if (linkedReviewIdValue) {
                savedReferenceId = linkedReviewIdValue.textContent;
            }
            
            // éšè—æ­£å¸¸å…³è”çŠ¶æ€
            const linkedState = document.getElementById('linkedState');
            if (linkedState) {
                linkedState.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå–æ¶ˆå…³è”çŠ¶æ€
            const cancelledState = document.getElementById('cancelledState');
            if (cancelledState) {
                cancelledState.style.display = 'flex';
            }
            
            console.log(`å·²å–æ¶ˆå‚è€ƒå¤ç›˜IDå…³è”: ${savedReferenceId}`);
            showNotification('å·²å–æ¶ˆå‚è€ƒå¤ç›˜IDå…³è”', 'success');
        }

        // é‡æ–°å…³è”å‚è€ƒå¤ç›˜ID
        function restoreReference(event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¼¹æ¡†å…³é—­
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log('é‡æ–°å…³è”å‚è€ƒå¤ç›˜ID');
            
            // æ¢å¤å‚è€ƒå¤ç›˜IDå€¼
            const linkedReviewIdValue = document.getElementById('linkedReviewIdValue');
            if (linkedReviewIdValue && savedReferenceId) {
                linkedReviewIdValue.textContent = savedReferenceId;
            }
            
            // éšè—å–æ¶ˆå…³è”çŠ¶æ€
            const cancelledState = document.getElementById('cancelledState');
            if (cancelledState) {
                cancelledState.style.display = 'none';
            }
            
            // æ˜¾ç¤ºæ­£å¸¸å…³è”çŠ¶æ€
            const linkedState = document.getElementById('linkedState');
            if (linkedState) {
                linkedState.style.display = 'block';
            }
            
            console.log(`å·²é‡æ–°å…³è”å‚è€ƒå¤ç›˜ID: ${savedReferenceId}`);
            showNotification(`å·²é‡æ–°å…³è”å‚è€ƒå¤ç›˜ID: ${savedReferenceId}`, 'success');
        }

        // ========== è§’è‰²æƒé™ç®¡ç†åŠŸèƒ½ ==========
        
        // åˆå§‹åŒ–è§’è‰²ç®¡ç†
        function initRoleManagement() {
            console.log('=== åˆå§‹åŒ–è§’è‰²ç®¡ç†ç³»ç»Ÿ ===');
            
            const roleSelect = document.getElementById('roleSelect');
            if (!roleSelect) {
                console.error('æœªæ‰¾åˆ°è§’è‰²é€‰æ‹©å™¨å…ƒç´  #roleSelect');
                return;
            }
            
            console.log('æ‰¾åˆ°è§’è‰²é€‰æ‹©å™¨ï¼Œå½“å‰é€‰ä¸­å€¼:', roleSelect.value);
            console.log('å½“å‰å…¨å±€è§’è‰²å˜é‡:', currentRole);
            
            // ç¡®ä¿å½“å‰è§’è‰²ä¸é€‰æ‹©å™¨å€¼åŒæ­¥
            currentRole = roleSelect.value || 'client';
            roleSelect.value = currentRole; // ç¡®ä¿é€‰æ‹©å™¨æ˜¾ç¤ºæ­£ç¡®å€¼
            
            console.log('åŒæ­¥åçš„è§’è‰²å€¼:', currentRole);
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
            roleSelect.removeEventListener('change', handleRoleChange);
            roleSelect.addEventListener('change', handleRoleChange);
            console.log('äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');
            
            // ç«‹å³åº”ç”¨åˆå§‹è§’è‰²æƒé™
            console.log('åº”ç”¨åˆå§‹è§’è‰²æƒé™...');
            applyRolePermissions(currentRole);
            
            console.log('=== è§’è‰²ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
        }

        // å¤„ç†è§’è‰²åˆ‡æ¢
        function handleRoleChange(event) {
            const newRole = event.target.value;
            console.log('=== å¼€å§‹è§’è‰²åˆ‡æ¢ ===');
            console.log('ä»è§’è‰²:', currentRole, 'åˆ‡æ¢åˆ°:', newRole);
            
            currentRole = newRole;
            console.log('å½“å‰è§’è‰²å·²æ›´æ–°ä¸º:', currentRole);
            
            // å¼ºåˆ¶é‡æ–°åº”ç”¨æƒé™
            applyRolePermissions(currentRole);
            
            // éªŒè¯åˆ‡æ¢ç»“æœ
            setTimeout(() => {
                verifyRoleSwitch(currentRole);
            }, 50);
            
            showNotification(`å·²åˆ‡æ¢è‡³${getRoleDisplayName(currentRole)}è§’è‰²`, 'success');
            console.log('=== è§’è‰²åˆ‡æ¢å®Œæˆ ===');
        }

        // åº”ç”¨è§’è‰²æƒé™
        function applyRolePermissions(role) {
            console.log('åº”ç”¨è§’è‰²æƒé™:', role);
            
            // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—å…ƒç´ 
            toggleElementsByRole(role);
            
            // æ ¹æ®è§’è‰²æ§åˆ¶æ‹–æ‹½åŠŸèƒ½
            updateDragDropPermissions(role);
            
            // æ ¹æ®è§’è‰²æ§åˆ¶æŒ‰é’®æ“ä½œ
            updateButtonPermissions(role);
        }

        // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—å…ƒç´ 
        function toggleElementsByRole(role) {
            console.log('=== å¼€å§‹åº”ç”¨è§’è‰²æƒé™ ===');
            console.log('ç›®æ ‡è§’è‰²:', role);
            
            // è·å–æ‰€æœ‰éœ€è¦æ§åˆ¶çš„å…ƒç´ 
            const elements = {
                newDemandBtn: document.getElementById('newDemandBtn'),
                applyBtn: document.getElementById('applyBtn'),
                pendingEditBtns: document.querySelectorAll('[data-status="pending"] .card-edit-btn'),
                pendingDeleteBtns: document.querySelectorAll('[data-status="pending"] .card-delete-btn'),
                uploadDesignBtns: document.querySelectorAll('.card-upload-btn'),
                uploadDataBtns: document.querySelectorAll('.card-upload-btn'),
                modifyDataBtns: document.querySelectorAll('.card-modify-btn'),
                modifyDesignBtns: document.querySelectorAll('.card-modify-design-btn')
            };
            
            // è¿‡æ»¤ä¸Šä¼ æŒ‰é’®ç±»å‹ - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
            elements.uploadDesignBtns = Array.from(elements.uploadDesignBtns).filter(btn => 
                btn.textContent && btn.textContent.includes('ä¸Šä¼ è®¾è®¡ç¨¿')
            );
            elements.uploadDataBtns = Array.from(elements.uploadDataBtns).filter(btn => 
                btn.textContent && btn.textContent.includes('ä¸Šä¼ å¤ç›˜æ•°æ®')
            );
            
            console.log('æ‰¾åˆ°çš„å…ƒç´ æ•°é‡:');
            console.log('- æ–°å¢éœ€æ±‚æŒ‰é’®:', elements.newDemandBtn ? 1 : 0);
            console.log('- åº”ç”¨æŒ‰é’®:', elements.applyBtn ? 1 : 0);
            console.log('- å¾…ç¡®è®¤ç¼–è¾‘æŒ‰é’®:', elements.pendingEditBtns.length);
            console.log('- å¾…ç¡®è®¤åˆ é™¤æŒ‰é’®:', elements.pendingDeleteBtns.length);
            console.log('- ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®:', elements.uploadDesignBtns.length);
            console.log('- ä¸Šä¼ å¤ç›˜æ•°æ®æŒ‰é’®:', elements.uploadDataBtns.length);
            console.log('- ä¿®æ”¹å¤ç›˜æ•°æ®æŒ‰é’®:', elements.modifyDataBtns.length);
            console.log('- ä¿®æ”¹è®¾è®¡ç¨¿æŒ‰é’®:', elements.modifyDesignBtns.length);

            // å…ˆéšè—æ‰€æœ‰å…ƒç´ 
            const allElements = [
                elements.newDemandBtn,
                elements.applyBtn,
                ...elements.pendingEditBtns,
                ...elements.pendingDeleteBtns,
                ...elements.uploadDesignBtns,
                ...elements.uploadDataBtns,
                ...elements.modifyDataBtns,
                ...elements.modifyDesignBtns
            ].filter(el => el); // è¿‡æ»¤æ‰null/undefined
            
            console.log('éšè—æ‰€æœ‰å…ƒç´ ...');
            allElements.forEach(el => hideElement(el));

            // æ ¹æ®è§’è‰²æ˜¾ç¤ºå¯¹åº”å…ƒç´ 
            switch(role) {
                case 'client':
                    console.log('åº”ç”¨å®¢æˆ·è§’è‰²æƒé™...');
                    if (elements.newDemandBtn) showElement(elements.newDemandBtn);
                    if (elements.applyBtn) showElement(elements.applyBtn);
                    elements.pendingEditBtns.forEach(btn => showElement(btn));
                    elements.pendingDeleteBtns.forEach(btn => showElement(btn));
                    console.log('å®¢æˆ·è§’è‰²æƒé™åº”ç”¨å®Œæˆ');
                    break;
                    
                case 'designer':
                    console.log('åº”ç”¨è®¾è®¡å¸ˆè§’è‰²æƒé™...');
                    elements.uploadDesignBtns.forEach(btn => showElement(btn));
                    elements.modifyDesignBtns.forEach(btn => showElement(btn));
                    console.log('è®¾è®¡å¸ˆè§’è‰²æƒé™åº”ç”¨å®Œæˆ');
                    break;
                    
                case 'operator':
                    console.log('åº”ç”¨è¿è¥è§’è‰²æƒé™...');
                    elements.uploadDataBtns.forEach(btn => showElement(btn));
                    elements.modifyDataBtns.forEach(btn => showElement(btn));
                    console.log('è¿è¥è§’è‰²æƒé™åº”ç”¨å®Œæˆ');
                    break;
                    
                default:
                    console.warn('æœªçŸ¥è§’è‰²:', role);
            }
            
            console.log('=== è§’è‰²æƒé™åº”ç”¨å®Œæˆ ===');
        }

        // æ›´æ–°æ‹–æ‹½æƒé™
        function updateDragDropPermissions(role) {
            const allCards = document.querySelectorAll('.kanban-card');
            
            allCards.forEach(card => {
                const column = card.closest('.kanban-column');
                const status = column.dataset.status;
                
                switch(role) {
                    case 'client':
                        // å®¢æˆ·ä¸å¯æ‹–æ‹½ä»»ä½•å¡ç‰‡
                        card.draggable = false;
                        card.style.cursor = 'default';
                        break;
                        
                    case 'designer':
                        // è®¾è®¡å¸ˆä¸å¯æ‹–æ‹½é¢„å”®æµ‹è¯•å’Œå·²å¤ç›˜å¡ç‰‡
                        if (status === 'testing' || status === 'reviewed') {
                            card.draggable = false;
                            card.style.cursor = 'default';
                        } else {
                            card.draggable = true;
                            card.style.cursor = 'grab';
                        }
                        break;
                        
                    case 'operator':
                        // è¿è¥å¯ä»¥æ‹–æ‹½æ‰€æœ‰å¡ç‰‡
                        card.draggable = true;
                        card.style.cursor = 'grab';
                        break;
                }
            });
        }

        // æ›´æ–°æŒ‰é’®æƒé™
        function updateButtonPermissions(role) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„æŒ‰é’®æƒé™æ§åˆ¶é€»è¾‘
            console.log('æ›´æ–°æŒ‰é’®æƒé™:', role);
        }

        // æ˜¾ç¤ºå…ƒç´ 
        function showElement(element) {
            if (element) {
                element.style.display = '';
                element.style.visibility = 'visible';
                console.log('æ˜¾ç¤ºå…ƒç´ :', element.id || element.className || element.textContent?.substring(0, 20));
            } else {
                console.warn('å°è¯•æ˜¾ç¤ºçš„å…ƒç´ ä¸å­˜åœ¨');
            }
        }

        // éšè—å…ƒç´ 
        function hideElement(element) {
            if (element) {
                element.style.display = 'none';
                console.log('éšè—å…ƒç´ :', element.id || element.className || element.textContent?.substring(0, 20));
            } else {
                console.warn('å°è¯•éšè—çš„å…ƒç´ ä¸å­˜åœ¨');
            }
        }

        // éªŒè¯è§’è‰²åˆ‡æ¢ç»“æœ
        function verifyRoleSwitch(role) {
            console.log('=== éªŒè¯è§’è‰²åˆ‡æ¢ç»“æœ ===');
            console.log('éªŒè¯è§’è‰²:', role);
            
            const elements = {
                newDemandBtn: document.getElementById('newDemandBtn'),
                applyBtn: document.getElementById('applyBtn')
            };
            
            // æ£€æŸ¥ä¸»è¦æŒ‰é’®
            Object.keys(elements).forEach(key => {
                const element = elements[key];
                if (element) {
                    const displayStyle = getComputedStyle(element).display;
                    const isVisible = displayStyle !== 'none';
                    console.log(`${key}: ${isVisible ? 'æ˜¾ç¤º' : 'éšè—'} (display: ${displayStyle})`);
                } else {
                    console.log(`${key}: å…ƒç´ æœªæ‰¾åˆ°`);
                }
            });
            
            // æ£€æŸ¥ä¸Šä¼ æŒ‰é’®
            const allUploadBtns = document.querySelectorAll('.card-upload-btn');
            console.log(`æ‰¾åˆ° ${allUploadBtns.length} ä¸ªä¸Šä¼ æŒ‰é’®`);
            
            allUploadBtns.forEach((btn, index) => {
                const displayStyle = getComputedStyle(btn).display;
                const isVisible = displayStyle !== 'none';
                const buttonText = btn.textContent || btn.innerText || 'Unknown';
                console.log(`ä¸Šä¼ æŒ‰é’®${index + 1} [${buttonText}]: ${isVisible ? 'æ˜¾ç¤º' : 'éšè—'}`);
            });
            
            // æ£€æŸ¥ä¿®æ”¹æŒ‰é’®
            const modifyBtns = document.querySelectorAll('.card-modify-btn');
            modifyBtns.forEach((btn, index) => {
                const displayStyle = getComputedStyle(btn).display;
                const isVisible = displayStyle !== 'none';
                console.log(`ä¿®æ”¹æŒ‰é’®${index + 1}: ${isVisible ? 'æ˜¾ç¤º' : 'éšè—'}`);
            });
            
            console.log('=== éªŒè¯å®Œæˆ ===');
        }

        // æ‰‹åŠ¨æµ‹è¯•è§’è‰²æƒé™ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        window.testRolePermissions = function(role) {
            console.log('=== æ‰‹åŠ¨æµ‹è¯•è§’è‰²æƒé™ ===');
            console.log('æµ‹è¯•è§’è‰²:', role);
            currentRole = role;
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                roleSelect.value = role;
            }
            applyRolePermissions(role);
            setTimeout(() => {
                verifyRoleSwitch(role);
            }, 100);
        };

        // æµ‹è¯•å¡ç‰‡çŠ¶æ€å˜æ›´åçš„æƒé™åº”ç”¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        window.testCardStateChange = function() {
            console.log('=== æµ‹è¯•å¡ç‰‡çŠ¶æ€å˜æ›´æƒé™åº”ç”¨ ===');
            
            // æ¨¡æ‹Ÿä»å¾…ç¡®è®¤æ‹–æ‹½åˆ°è®¾è®¡ä¸­çš„æƒ…å†µ
            console.log('æ¨¡æ‹Ÿåœºæ™¯ï¼šå¾…ç¡®è®¤å¡ç‰‡æ‹–æ‹½åˆ°è®¾è®¡ä¸­çŠ¶æ€');
            console.log('å½“å‰è§’è‰²:', getRoleDisplayName(currentRole));
            
            // åº”ç”¨è®¾è®¡å¸ˆæƒé™
            if (currentRole !== 'designer') {
                console.log('åˆ‡æ¢åˆ°è®¾è®¡å¸ˆè§’è‰²è¿›è¡Œæµ‹è¯•...');
                currentRole = 'designer';
                const roleSelect = document.getElementById('roleSelect');
                if (roleSelect) {
                    roleSelect.value = 'designer';
                }
            }
            
            console.log('é‡æ–°åº”ç”¨è§’è‰²æƒé™...');
            applyRolePermissions(currentRole);
            
            setTimeout(() => {
                console.log('éªŒè¯è®¾è®¡ä¸­åˆ—çš„ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€:');
                const uploadDesignBtns = document.querySelectorAll('.card-upload-btn');
                let designBtnCount = 0;
                uploadDesignBtns.forEach((btn, index) => {
                    if (btn.textContent && btn.textContent.includes('ä¸Šä¼ è®¾è®¡ç¨¿')) {
                        designBtnCount++;
                        const displayStyle = getComputedStyle(btn).display;
                        const isVisible = displayStyle !== 'none';
                        console.log(`ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®${designBtnCount}: ${isVisible ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                    }
                });
                if (designBtnCount === 0) {
                    console.log('âŒ æœªæ‰¾åˆ°ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®');
                }
            }, 100);
        };

        // æµ‹è¯•çŠ¶æ€å˜æ›´åŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿæ‹–æ‹½ï¼‰
        window.testDragStateChange = function() {
            console.log('=== æµ‹è¯•æ‹–æ‹½çŠ¶æ€å˜æ›´åŠŸèƒ½ ===');
            
            // æ‰¾åˆ°ç¬¬ä¸€å¼ å¾…ç¡®è®¤çš„å¡ç‰‡
            const pendingCard = document.querySelector('[data-status="pending"] .kanban-card');
            if (!pendingCard) {
                console.log('âŒ æœªæ‰¾åˆ°å¾…ç¡®è®¤çŠ¶æ€çš„å¡ç‰‡');
                return;
            }
            
            console.log('æ‰¾åˆ°å¾…ç¡®è®¤å¡ç‰‡ï¼ŒID:', pendingCard.dataset.id);
            console.log('å½“å‰å¡ç‰‡æ“ä½œæŒ‰é’®:');
            const currentBtns = pendingCard.querySelectorAll('button');
            currentBtns.forEach(btn => {
                console.log(`- ${btn.textContent}: ${getComputedStyle(btn).display !== 'none' ? 'æ˜¾ç¤º' : 'éšè—'}`);
            });
            
            // æ¨¡æ‹Ÿå°†å¡ç‰‡çŠ¶æ€å˜æ›´ä¸ºè®¾è®¡ä¸­
            console.log('æ¨¡æ‹Ÿå°†å¡ç‰‡çŠ¶æ€å˜æ›´ä¸º"è®¾è®¡ä¸­"...');
            updateCardStatus(pendingCard, 'designing');
            
            // åˆ‡æ¢åˆ°è®¾è®¡å¸ˆè§’è‰²
            currentRole = 'designer';
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                roleSelect.value = 'designer';
            }
            
            // åº”ç”¨æƒé™
            applyRolePermissions(currentRole);
            
            setTimeout(() => {
                console.log('çŠ¶æ€å˜æ›´åçš„å¡ç‰‡æ“ä½œæŒ‰é’®:');
                const newBtns = pendingCard.querySelectorAll('button');
                newBtns.forEach(btn => {
                    const isVisible = getComputedStyle(btn).display !== 'none';
                    console.log(`- ${btn.textContent}: ${isVisible ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®
                const uploadDesignBtn = pendingCard.querySelector('button');
                const hasUploadDesignBtn = Array.from(pendingCard.querySelectorAll('button'))
                    .some(btn => btn.textContent.includes('ä¸Šä¼ è®¾è®¡ç¨¿'));
                
                if (hasUploadDesignBtn) {
                    console.log('âœ… æˆåŠŸï¼å¡ç‰‡ç°åœ¨æœ‰ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®');
                } else {
                    console.log('âŒ å¤±è´¥ï¼å¡ç‰‡ç¼ºå°‘ä¸Šä¼ è®¾è®¡ç¨¿æŒ‰é’®');
                }
            }, 100);
        };

        // æµ‹è¯•å·²äº¤ä»˜åˆ—ä¿®æ”¹è®¾è®¡ç¨¿åŠŸèƒ½
        window.testModifyDesignFeature = function() {
            console.log('=== æµ‹è¯•å·²äº¤ä»˜åˆ—ä¿®æ”¹è®¾è®¡ç¨¿åŠŸèƒ½ ===');
            
            // åˆ‡æ¢åˆ°è®¾è®¡å¸ˆè§’è‰²
            console.log('åˆ‡æ¢åˆ°è®¾è®¡å¸ˆè§’è‰²...');
            currentRole = 'designer';
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                roleSelect.value = 'designer';
            }
            
            // åº”ç”¨è®¾è®¡å¸ˆæƒé™
            applyRolePermissions(currentRole);
            
            setTimeout(() => {
                console.log('éªŒè¯å·²äº¤ä»˜åˆ—çš„ä¿®æ”¹è®¾è®¡ç¨¿æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€:');
                const modifyDesignBtns = document.querySelectorAll('.card-modify-design-btn');
                
                if (modifyDesignBtns.length === 0) {
                    console.log('âŒ æœªæ‰¾åˆ°ä¿®æ”¹è®¾è®¡ç¨¿æŒ‰é’®');
                    return;
                }
                
                modifyDesignBtns.forEach((btn, index) => {
                    const displayStyle = getComputedStyle(btn).display;
                    const isVisible = displayStyle !== 'none';
                    const cardId = btn.onclick.toString().match(/'([^']+)'/)?.[1] || 'unknown';
                    console.log(`ä¿®æ”¹è®¾è®¡ç¨¿æŒ‰é’®${index + 1} (å¡ç‰‡ID: ${cardId}): ${isVisible ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                });
                
                // æµ‹è¯•æƒé™éªŒè¯
                console.log('æµ‹è¯•æƒé™éªŒè¯...');
                const testResult = checkButtonPermission('modifyDesign', 'delivered');
                console.log(`è®¾è®¡å¸ˆåœ¨å·²äº¤ä»˜çŠ¶æ€çš„ä¿®æ”¹è®¾è®¡ç¨¿æƒé™: ${testResult ? 'âœ… æœ‰æƒé™' : 'âŒ æ— æƒé™'}`);
                
                // æµ‹è¯•å…¶ä»–è§’è‰²æƒé™
                console.log('æµ‹è¯•å…¶ä»–è§’è‰²æƒé™...');
                const originalRole = currentRole;
                
                currentRole = 'client';
                const clientResult = checkButtonPermission('modifyDesign', 'delivered');
                console.log(`å®¢æˆ·åœ¨å·²äº¤ä»˜çŠ¶æ€çš„ä¿®æ”¹è®¾è®¡ç¨¿æƒé™: ${clientResult ? 'âœ… æœ‰æƒé™' : 'âŒ æ— æƒé™'}`);
                
                currentRole = 'operator';
                const operatorResult = checkButtonPermission('modifyDesign', 'delivered');
                console.log(`è¿è¥åœ¨å·²äº¤ä»˜çŠ¶æ€çš„ä¿®æ”¹è®¾è®¡ç¨¿æƒé™: ${operatorResult ? 'âœ… æœ‰æƒé™' : 'âŒ æ— æƒé™'}`);
                
                // æ¢å¤åŸè§’è‰²
                currentRole = originalRole;
                
                console.log('=== æµ‹è¯•å®Œæˆ ===');
            }, 100);
        };

        // è·å–è§’è‰²æ˜¾ç¤ºåç§°
        function getRoleDisplayName(role) {
            const roleMap = {
                'client': 'å®¢æˆ·',
                'designer': 'è®¾è®¡å¸ˆ',
                'operator': 'è¿è¥'
            };
            return roleMap[role] || role;
        }

        // æ£€æŸ¥å½“å‰è§’è‰²æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸæ“ä½œ
        function hasPermission(action) {
            const permissions = {
                'client': ['newDemand', 'applyReference', 'editPending', 'deletePending'],
                'designer': ['uploadDesign', 'dragNonRestricted'],
                'operator': ['uploadReviewData', 'modifyReviewData', 'dragAll']
            };
            
            return permissions[currentRole] && permissions[currentRole].includes(action);
        }

        // æ£€æŸ¥æ‹–æ‹½æƒé™
        function checkDragPermission(fromStatus, toStatus) {
            switch(currentRole) {
                case 'client':
                    // å®¢æˆ·ä¸å¯æ‹–æ‹½ä»»ä½•å¡ç‰‡
                    return false;
                    
                case 'designer':
                    // è®¾è®¡å¸ˆä¸å¯æ‹–æ‹½é¢„å”®æµ‹è¯•å’Œå·²å¤ç›˜çŠ¶æ€çš„å¡ç‰‡
                    if (fromStatus === 'testing' || fromStatus === 'reviewed' ||
                        toStatus === 'testing' || toStatus === 'reviewed') {
                        return false;
                    }
                    return true;
                    
                case 'operator':
                    // è¿è¥å¯ä»¥æ‹–æ‹½æ‰€æœ‰å¡ç‰‡
                    return true;
                    
                default:
                    return false;
            }
        }

        // æ£€æŸ¥æŒ‰é’®æ“ä½œæƒé™
        function checkButtonPermission(action, cardStatus) {
            switch(currentRole) {
                case 'client':
                    if (action === 'edit' || action === 'delete') {
                        return cardStatus === 'pending';
                    }
                    return false;
                    
                case 'designer':
                    if (action === 'uploadDesign') {
                        return cardStatus === 'designing';
                    }
                    if (action === 'modifyDesign') {
                        return cardStatus === 'delivered';
                    }
                    return false;
                    
                case 'operator':
                    if (action === 'uploadReviewData') {
                        return cardStatus === 'testing';
                    }
                    if (action === 'modifyReviewData') {
                        return cardStatus === 'reviewed';
                    }
                    return false;
                    
                default:
                    return false;
            }
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInTop {
                from {
                    transform: translateX(-50%) translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutTop {
                from {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-50%) translateY(-100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // æµ‹è¯•é€šçŸ¥åŠŸèƒ½
        window.testNotification = function() {
            console.log('ğŸ§ª æµ‹è¯•é€šçŸ¥åŠŸèƒ½ - é¡µé¢å±…ä¸­ä¸Šæ–¹æ˜¾ç¤º');
            showNotification('æµ‹è¯•æˆåŠŸé€šçŸ¥ - å±…ä¸­ä¸Šæ–¹æ˜¾ç¤º', 'success');
            setTimeout(() => {
                showNotification('æµ‹è¯•é”™è¯¯é€šçŸ¥ - å±…ä¸­ä¸Šæ–¹æ˜¾ç¤º', 'error');
            }, 1000);
            setTimeout(() => {
                showNotification('æµ‹è¯•ä¿¡æ¯é€šçŸ¥ - å±…ä¸­ä¸Šæ–¹æ˜¾ç¤º', 'info');
            }, 2000);
        };

        // æµ‹è¯•å‚è€ƒå¤ç›˜IDåŠŸèƒ½
        window.testReferenceReviewId = function() {
            console.log('ğŸ§ª æµ‹è¯•å‚è€ƒå¤ç›˜IDåŠŸèƒ½ - ä¿®å¤ç‰ˆæœ¬');
            
            // æµ‹è¯•1ï¼šåˆ›å»ºä¸€ä¸ªæœ‰å‚è€ƒå¤ç›˜IDçš„æµ‹è¯•å¡ç‰‡ï¼Œæµ‹è¯•çŠ¶æ€å˜æ›´
            console.log('--- æµ‹è¯•1ï¼šçŠ¶æ€å˜æ›´ä¿æŒå‚è€ƒå¤ç›˜ID ---');
            const testCard = document.createElement('div');
            testCard.className = 'kanban-card';
            testCard.dataset.id = 'TEST_REF_' + Date.now();
            testCard.innerHTML = `
                <div class="card-status status-pending">å¾…ç¡®è®¤</div>
                <div class="card-review-id" style="display: none;">
                    <span class="field-label">å‚è€ƒå¤ç›˜ID:</span>
                    <span class="field-value review-id-value">20241215999</span>
                </div>
                <div class="card-update-time">æ›´æ–°: 2025-01-15 10:00:00</div>
            `;
            
            console.log('æµ‹è¯•å¡ç‰‡åˆ›å»ºå®Œæˆï¼Œå‚è€ƒå¤ç›˜ID:', testCard.querySelector('.review-id-value').textContent);
            
            // æµ‹è¯•çŠ¶æ€å˜æ›´ï¼špending -> designing -> delivered -> testing -> reviewed
            const statusSequence = ['designing', 'delivered', 'testing', 'reviewed'];
            let allTestsPassed = true;
            
            statusSequence.forEach((status, index) => {
                console.log(`\næ­¥éª¤ ${index + 1}: å˜æ›´ä¸º ${status} çŠ¶æ€`);
                updateCardStatus(testCard, status);
                
                // æ£€æŸ¥å‚è€ƒå¤ç›˜IDæ˜¯å¦å¯è§
                const referenceElements = testCard.querySelectorAll('.card-review-id');
                let referenceVisible = false;
                
                referenceElements.forEach(element => {
                    const label = element.querySelector('.field-label');
                    if (label && label.textContent.includes('å‚è€ƒå¤ç›˜ID')) {
                        const computedStyle = getComputedStyle(element);
                        referenceVisible = computedStyle.display !== 'none';
                        console.log(`å‚è€ƒå¤ç›˜IDæ˜¾ç¤ºçŠ¶æ€: ${referenceVisible ? 'å¯è§' : 'éšè—'}`);
                    }
                });
                
                if (!referenceVisible) {
                    console.log(`âŒ åœ¨${status}çŠ¶æ€ä¸‹å‚è€ƒå¤ç›˜IDä¸å¯è§`);
                    allTestsPassed = false;
                } else {
                    console.log(`âœ… åœ¨${status}çŠ¶æ€ä¸‹å‚è€ƒå¤ç›˜IDæ­£å¸¸æ˜¾ç¤º`);
                }
            });
            
            // æµ‹è¯•2ï¼šæ£€æŸ¥ç°æœ‰å·²å¤ç›˜å¡ç‰‡çš„å‚è€ƒå¤ç›˜IDæ˜¾ç¤º
            console.log('\n--- æµ‹è¯•2ï¼šç°æœ‰å·²å¤ç›˜å¡ç‰‡å‚è€ƒå¤ç›˜IDæ˜¾ç¤º ---');
            const existingReviewedCards = document.querySelectorAll('[data-status="reviewed"] .kanban-card');
            existingReviewedCards.forEach((card, index) => {
                const referenceElements = card.querySelectorAll('.card-review-id');
                let hasReferenceId = false;
                let referenceVisible = false;
                
                referenceElements.forEach(element => {
                    const label = element.querySelector('.field-label');
                    const value = element.querySelector('.review-id-value');
                    if (label && label.textContent.includes('å‚è€ƒå¤ç›˜ID') && value && value.textContent.trim()) {
                        hasReferenceId = true;
                        const computedStyle = getComputedStyle(element);
                        referenceVisible = computedStyle.display !== 'none';
                    }
                });
                
                console.log(`å·²å¤ç›˜å¡ç‰‡ ${index + 1}: æœ‰å‚è€ƒå¤ç›˜ID=${hasReferenceId}, å¯è§=${referenceVisible}`);
            });
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            if (allTestsPassed) {
                console.log('\nâœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼šå‚è€ƒå¤ç›˜IDåœ¨æ‰€æœ‰çŠ¶æ€ä¸­éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º');
                showNotification('å‚è€ƒå¤ç›˜IDåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼', 'success');
            } else {
                console.log('\nâŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼šå‚è€ƒå¤ç›˜IDæ˜¾ç¤ºå­˜åœ¨é—®é¢˜');
                showNotification('å‚è€ƒå¤ç›˜IDåŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼', 'error');
            }
        };

        // æ¼”ç¤ºå‚è€ƒå¤ç›˜IDä¿®å¤æ•ˆæœ
        window.demoReferenceReviewIdFix = function() {
            console.log('ğŸ¯ æ¼”ç¤ºå‚è€ƒå¤ç›˜IDä¿®å¤æ•ˆæœ');
            showNotification('å¼€å§‹æ¼”ç¤ºå‚è€ƒå¤ç›˜IDä¿®å¤æ•ˆæœ', 'info');
            
            // æŸ¥æ‰¾æœ‰å‚è€ƒå¤ç›˜IDçš„å¡ç‰‡
            const cardWithReference = document.querySelector('[data-id="2"]');
            if (!cardWithReference) {
                console.log('âŒ æœªæ‰¾åˆ°æµ‹è¯•å¡ç‰‡');
                return;
            }
            
            console.log('æ‰¾åˆ°æœ‰å‚è€ƒå¤ç›˜IDçš„å¾…ç¡®è®¤å¡ç‰‡ï¼Œå¼€å§‹æ¼”ç¤ºæ‹–æ‹½æµç¨‹...');
            
            // æ¨¡æ‹Ÿå®Œæ•´çš„çŠ¶æ€æµè½¬
            const statusFlow = [
                { status: 'designing', name: 'è®¾è®¡ä¸­', delay: 2000 },
                { status: 'delivered', name: 'å·²äº¤ä»˜', delay: 4000 },
                { status: 'testing', name: 'é¢„å”®æµ‹è¯•', delay: 6000 },
                { status: 'reviewed', name: 'å·²å¤ç›˜', delay: 8000 }
            ];
            
            statusFlow.forEach(({ status, name, delay }) => {
                setTimeout(() => {
                    console.log(`\nğŸ”„ å°†å¡ç‰‡çŠ¶æ€å˜æ›´ä¸º: ${name}`);
                    updateCardStatus(cardWithReference, status);
                    
                    // å¦‚æœæ˜¯å·²å¤ç›˜çŠ¶æ€ï¼Œæ¨¡æ‹Ÿç”Ÿæˆå¤ç›˜IDçš„è¿‡ç¨‹
                    if (status === 'reviewed') {
                        generateReviewIdForCard(cardWithReference);
                    }
                    
                    // æ£€æŸ¥å‚è€ƒå¤ç›˜IDå’Œå¤ç›˜IDçš„æ˜¾ç¤ºæƒ…å†µ
                    const referenceElements = cardWithReference.querySelectorAll('.card-review-id');
                    let referenceVisible = false;
                    let referenceValue = '';
                    let reviewIdVisible = false;
                    let reviewIdValue = '';
                    
                    referenceElements.forEach(element => {
                        const label = element.querySelector('.field-label');
                        if (label) {
                            if (label.textContent.includes('å‚è€ƒå¤ç›˜ID')) {
                                const value = element.querySelector('.review-id-value');
                                if (value && value.textContent.trim()) {
                                    referenceVisible = getComputedStyle(element).display !== 'none';
                                    referenceValue = value.textContent.trim();
                                }
                            } else if (label.textContent.includes('å¤ç›˜ID:') && !label.textContent.includes('å‚è€ƒ')) {
                                const value = element.querySelector('.field-value');
                                if (value && value.textContent.trim()) {
                                    reviewIdVisible = getComputedStyle(element).display !== 'none';
                                    reviewIdValue = value.textContent.trim();
                                }
                            }
                        }
                    });
                    
                    if (status === 'reviewed') {
                        console.log(`ğŸ“Š å·²å¤ç›˜çŠ¶æ€æ£€æŸ¥ç»“æœ:`);
                        console.log(`   å‚è€ƒå¤ç›˜ID: ${referenceVisible ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'} - ${referenceValue}`);
                        console.log(`   å¤ç›˜ID: ${reviewIdVisible ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'} - ${reviewIdValue}`);
                        
                        if (referenceVisible && reviewIdVisible) {
                            showNotification(`âœ… ä¿®å¤æˆåŠŸï¼å‚è€ƒå¤ç›˜ID(${referenceValue}) å’Œ å¤ç›˜ID(${reviewIdValue}) åŒæ—¶æ˜¾ç¤º`, 'success');
                        } else if (referenceVisible && !reviewIdVisible) {
                            showNotification(`âš ï¸ å‚è€ƒå¤ç›˜IDæ˜¾ç¤ºæ­£å¸¸ï¼Œä½†å¤ç›˜IDæœªç”Ÿæˆ`, 'error');
                        } else if (!referenceVisible && reviewIdVisible) {
                            showNotification(`âŒ å¤ç›˜IDç”ŸæˆæˆåŠŸï¼Œä½†å‚è€ƒå¤ç›˜IDä¸¢å¤±ï¼`, 'error');
                        } else {
                            showNotification(`âŒ å‚è€ƒå¤ç›˜IDå’Œå¤ç›˜IDéƒ½ä¸¢å¤±ï¼`, 'error');
                        }
                    } else {
                        if (referenceVisible) {
                            console.log(`âœ… åœ¨${name}çŠ¶æ€ä¸‹ï¼Œå‚è€ƒå¤ç›˜IDä»ç„¶å¯è§: ${referenceValue}`);
                            showNotification(`${name}çŠ¶æ€ - å‚è€ƒå¤ç›˜IDä¿æŒæ˜¾ç¤º: ${referenceValue}`, 'success');
                        } else {
                            console.log(`âŒ åœ¨${name}çŠ¶æ€ä¸‹ï¼Œå‚è€ƒå¤ç›˜IDä¸å¯è§`);
                            showNotification(`${name}çŠ¶æ€ - å‚è€ƒå¤ç›˜IDä¸¢å¤±!`, 'error');
                        }
                    }
                    
                    if (status === 'reviewed') {
                        setTimeout(() => {
                            console.log('\nğŸ‰ æ¼”ç¤ºå®Œæˆï¼');
                            if (referenceVisible && reviewIdVisible) {
                                console.log('âœ… å‚è€ƒå¤ç›˜IDä¿®å¤æˆåŠŸï¼šå‚è€ƒå¤ç›˜IDå’Œå¤ç›˜IDåœ¨å·²å¤ç›˜çŠ¶æ€ä¸‹åŒæ—¶æ˜¾ç¤º');
                                showNotification('ğŸ‰ å‚è€ƒå¤ç›˜IDä¿®å¤æˆåŠŸï¼', 'success');
                            } else {
                                console.log('âŒ å‚è€ƒå¤ç›˜IDä¿®å¤ä»æœ‰é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•');
                                showNotification('âŒ å‚è€ƒå¤ç›˜IDä¿®å¤å¤±è´¥', 'error');
                            }
                        }, 1500);
                    }
                }, delay);
            });
        };

        // æµ‹è¯•å‚è€ƒå¤ç›˜IDåœ¨å·²å¤ç›˜çŠ¶æ€çš„ä¿æŒ
        window.testReviewedStatusReferenceId = function() {
            console.log('ğŸ§ª æµ‹è¯•å‚è€ƒå¤ç›˜IDåœ¨å·²å¤ç›˜çŠ¶æ€çš„ä¿æŒ');
            showNotification('æµ‹è¯•å‚è€ƒå¤ç›˜IDåœ¨å·²å¤ç›˜çŠ¶æ€çš„ä¿æŒ', 'info');
            
            // æŸ¥æ‰¾æœ‰å‚è€ƒå¤ç›˜IDçš„å¡ç‰‡
            const cardWithReference = document.querySelector('[data-id="2"]');
            if (!cardWithReference) {
                console.log('âŒ æœªæ‰¾åˆ°æµ‹è¯•å¡ç‰‡');
                showNotification('æœªæ‰¾åˆ°æµ‹è¯•å¡ç‰‡', 'error');
                return;
            }
            
            console.log('ğŸ“‹ å¼€å§‹æµ‹è¯•...');
            console.log('æ­¥éª¤1: æ£€æŸ¥å¡ç‰‡åˆå§‹çŠ¶æ€');
            
            // æ£€æŸ¥åˆå§‹çŠ¶æ€çš„å‚è€ƒå¤ç›˜ID
            let initialReferenceId = '';
            const initialElements = cardWithReference.querySelectorAll('.card-review-id');
            initialElements.forEach(element => {
                const label = element.querySelector('.field-label');
                const value = element.querySelector('.review-id-value');
                if (label && label.textContent.includes('å‚è€ƒå¤ç›˜ID') && value && value.textContent.trim()) {
                    initialReferenceId = value.textContent.trim();
                }
            });
            
            console.log(`åˆå§‹å‚è€ƒå¤ç›˜ID: ${initialReferenceId}`);
            
            // ç›´æ¥å°†å¡ç‰‡çŠ¶æ€å˜æ›´ä¸ºå·²å¤ç›˜
            console.log('æ­¥éª¤2: å°†å¡ç‰‡çŠ¶æ€ç›´æ¥å˜æ›´ä¸ºå·²å¤ç›˜');
            updateCardStatus(cardWithReference, 'reviewed');
            
            // æ¨¡æ‹Ÿç”Ÿæˆå¤ç›˜ID
            console.log('æ­¥éª¤3: ç”Ÿæˆå¤ç›˜ID');
            generateReviewIdForCard(cardWithReference);
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç„¶åæ£€æŸ¥ç»“æœ
            setTimeout(() => {
                console.log('æ­¥éª¤4: æ£€æŸ¥æœ€ç»ˆç»“æœ');
                
                const finalElements = cardWithReference.querySelectorAll('.card-review-id');
                let finalReferenceId = '';
                let finalReviewId = '';
                let referenceVisible = false;
                let reviewIdVisible = false;
                
                finalElements.forEach(element => {
                    const label = element.querySelector('.field-label');
                    if (label) {
                        if (label.textContent.includes('å‚è€ƒå¤ç›˜ID')) {
                            const value = element.querySelector('.review-id-value');
                            if (value && value.textContent.trim()) {
                                finalReferenceId = value.textContent.trim();
                                referenceVisible = getComputedStyle(element).display !== 'none';
                            }
                        } else if (label.textContent.includes('å¤ç›˜ID:') && !label.textContent.includes('å‚è€ƒ')) {
                            const value = element.querySelector('.field-value');
                            if (value && value.textContent.trim()) {
                                finalReviewId = value.textContent.trim();
                                reviewIdVisible = getComputedStyle(element).display !== 'none';
                            }
                        }
                    }
                });
                
                console.log('\nğŸ“Š æµ‹è¯•ç»“æœ:');
                console.log(`   åˆå§‹å‚è€ƒå¤ç›˜ID: ${initialReferenceId}`);
                console.log(`   æœ€ç»ˆå‚è€ƒå¤ç›˜ID: ${finalReferenceId} (${referenceVisible ? 'å¯è§' : 'éšè—'})`);
                console.log(`   ç”Ÿæˆçš„å¤ç›˜ID: ${finalReviewId} (${reviewIdVisible ? 'å¯è§' : 'éšè—'})`);
                
                // åˆ¤æ–­æµ‹è¯•ç»“æœ
                const referenceIdPreserved = initialReferenceId && finalReferenceId === initialReferenceId && referenceVisible;
                const reviewIdGenerated = finalReviewId && reviewIdVisible;
                
                if (referenceIdPreserved && reviewIdGenerated) {
                    console.log('\nâœ… æµ‹è¯•é€šè¿‡ï¼šå‚è€ƒå¤ç›˜IDä¿æŒæ˜¾ç¤ºï¼Œå¤ç›˜IDæˆåŠŸç”Ÿæˆ');
                    showNotification(`âœ… æµ‹è¯•é€šè¿‡ï¼å‚è€ƒå¤ç›˜ID(${finalReferenceId}) å’Œ å¤ç›˜ID(${finalReviewId}) åŒæ—¶æ˜¾ç¤º`, 'success');
                } else if (referenceIdPreserved && !reviewIdGenerated) {
                    console.log('\nâš ï¸ éƒ¨åˆ†é€šè¿‡ï¼šå‚è€ƒå¤ç›˜IDä¿æŒæ˜¾ç¤ºï¼Œä½†å¤ç›˜IDæœªç”Ÿæˆ');
                    showNotification(`âš ï¸ å‚è€ƒå¤ç›˜IDä¿æŒï¼Œä½†å¤ç›˜IDç”Ÿæˆå¤±è´¥`, 'error');
                } else if (!referenceIdPreserved && reviewIdGenerated) {
                    console.log('\nâŒ æµ‹è¯•å¤±è´¥ï¼šå‚è€ƒå¤ç›˜IDä¸¢å¤±ï¼Œä½†å¤ç›˜IDç”ŸæˆæˆåŠŸ');
                    showNotification(`âŒ å‚è€ƒå¤ç›˜IDä¸¢å¤±ï¼ä»…æœ‰å¤ç›˜ID(${finalReviewId})`, 'error');
                } else {
                    console.log('\nâŒ æµ‹è¯•å¤±è´¥ï¼šå‚è€ƒå¤ç›˜IDå’Œå¤ç›˜IDéƒ½æœ‰é—®é¢˜');
                    showNotification('âŒ å‚è€ƒå¤ç›˜IDå’Œå¤ç›˜IDéƒ½æœ‰é—®é¢˜', 'error');
                }
            }, 500);
        };

        // æµ‹è¯•å‚è€ƒå¤ç›˜IDå–æ¶ˆå’Œé‡æ–°å…³è”åŠŸèƒ½
        window.testReferenceToggle = function() {
            console.log('ğŸ§ª æµ‹è¯•å‚è€ƒå¤ç›˜IDå–æ¶ˆå’Œé‡æ–°å…³è”åŠŸèƒ½');
            showNotification('å¼€å§‹æµ‹è¯•å‚è€ƒå¤ç›˜IDå–æ¶ˆå’Œé‡æ–°å…³è”åŠŸèƒ½', 'info');
            
            // æ¨¡æ‹Ÿæ‰“å¼€"åº”ç”¨è‡³æ–°éœ€æ±‚å‚è€ƒ"å¼¹æ¡†
            console.log('æ­¥éª¤1: æ¨¡æ‹Ÿé€šè¿‡"åº”ç”¨è‡³æ–°éœ€æ±‚å‚è€ƒ"æ‰“å¼€å¼¹æ¡†');
            
            // æ‰“å¼€æŠ½å±‰
            const drawer = document.getElementById('demandDrawer');
            if (drawer) {
                drawer.style.display = 'flex';
                setTimeout(() => {
                    drawer.classList.add('show');
                }, 10);
            }
            
            // åº”ç”¨å¤ç›˜æ•°æ®
            applyReviewData();
            
            setTimeout(() => {
                console.log('æ­¥éª¤2: æ£€æŸ¥åˆå§‹çŠ¶æ€');
                const linkedState = document.getElementById('linkedState');
                const cancelledState = document.getElementById('cancelledState');
                const linkedReviewIdValue = document.getElementById('linkedReviewIdValue');
                
                console.log('- æ­£å¸¸å…³è”çŠ¶æ€æ˜¾ç¤º:', linkedState ? getComputedStyle(linkedState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                console.log('- å–æ¶ˆå…³è”çŠ¶æ€æ˜¾ç¤º:', cancelledState ? getComputedStyle(cancelledState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                console.log('- å‚è€ƒå¤ç›˜IDå€¼:', linkedReviewIdValue ? linkedReviewIdValue.textContent : 'æ— ');
                
                // æµ‹è¯•å–æ¶ˆå‚è€ƒåŠŸèƒ½
                setTimeout(() => {
                    console.log('\næ­¥éª¤3: æµ‹è¯•å–æ¶ˆå‚è€ƒåŠŸèƒ½');
                    cancelReference();
                    
                    setTimeout(() => {
                        console.log('- å–æ¶ˆåæ­£å¸¸å…³è”çŠ¶æ€:', linkedState ? getComputedStyle(linkedState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                        console.log('- å–æ¶ˆåå–æ¶ˆå…³è”çŠ¶æ€:', cancelledState ? getComputedStyle(cancelledState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                        
                        // æµ‹è¯•é‡æ–°å…³è”åŠŸèƒ½
                        setTimeout(() => {
                            console.log('\næ­¥éª¤4: æµ‹è¯•é‡æ–°å…³è”åŠŸèƒ½');
                            restoreReference();
                            
                            setTimeout(() => {
                                console.log('- æ¢å¤åæ­£å¸¸å…³è”çŠ¶æ€:', linkedState ? getComputedStyle(linkedState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                                console.log('- æ¢å¤åå–æ¶ˆå…³è”çŠ¶æ€:', cancelledState ? getComputedStyle(cancelledState).display : 'å…ƒç´ ä¸å­˜åœ¨');
                                console.log('- æ¢å¤åå‚è€ƒå¤ç›˜IDå€¼:', linkedReviewIdValue ? linkedReviewIdValue.textContent : 'æ— ');
                                
                                console.log('\nâœ… æµ‹è¯•å®Œæˆï¼å‚è€ƒå¤ç›˜IDå–æ¶ˆå’Œé‡æ–°å…³è”åŠŸèƒ½æ­£å¸¸å·¥ä½œ');
                                showNotification('âœ… å‚è€ƒå¤ç›˜IDå–æ¶ˆå’Œé‡æ–°å…³è”åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
                            }, 500);
                        }, 2000);
                    }, 500);
                }, 2000);
            }, 1000);
        };

        // æµ‹è¯•å–æ¶ˆå‚è€ƒæŒ‰é’®ä¸ä¼šå…³é—­å¼¹æ¡†çš„ä¿®å¤
        window.testCancelReferenceNoClose = function() {
            console.log('ğŸ§ª æµ‹è¯•å–æ¶ˆå‚è€ƒæŒ‰é’®ä¸ä¼šå…³é—­å¼¹æ¡†çš„ä¿®å¤');
            showNotification('å¼€å§‹æµ‹è¯•å–æ¶ˆå‚è€ƒæŒ‰é’®åŠŸèƒ½', 'info');
            
            // 1. æ‰“å¼€å¼¹æ¡†
            console.log('æ­¥éª¤1: æ‰“å¼€æ–°å¢éœ€æ±‚å¼¹æ¡†');
            const drawer = document.getElementById('demandDrawer');
            if (drawer) {
                drawer.style.display = 'flex';
                setTimeout(() => {
                    drawer.classList.add('show');
                }, 10);
            }
            
            // 2. åº”ç”¨å¤ç›˜æ•°æ®
            setTimeout(() => {
                console.log('æ­¥éª¤2: åº”ç”¨å¤ç›˜æ•°æ®ï¼Œæ˜¾ç¤ºå‚è€ƒå¤ç›˜ID');
                applyReviewData();
                
                // 3. æµ‹è¯•å–æ¶ˆå‚è€ƒåŠŸèƒ½
                setTimeout(() => {
                    console.log('æ­¥éª¤3: ç‚¹å‡»å–æ¶ˆå‚è€ƒæŒ‰é’®');
                    
                    // æ£€æŸ¥å¼¹æ¡†çŠ¶æ€ï¼ˆç‚¹å‡»å‰ï¼‰
                    const drawerBefore = document.getElementById('demandDrawer');
                    const isVisibleBefore = drawerBefore && drawerBefore.classList.contains('show');
                    console.log('- ç‚¹å‡»å‰å¼¹æ¡†æ˜¯å¦æ˜¾ç¤º:', isVisibleBefore);
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»å–æ¶ˆå‚è€ƒæŒ‰é’®ï¼ˆåŒ…å«äº‹ä»¶å¯¹è±¡ï¼‰
                    const mockEvent = {
                        stopPropagation: () => console.log('  é˜»æ­¢äº‹ä»¶å†’æ³¡'),
                        preventDefault: () => console.log('  é˜»æ­¢é»˜è®¤è¡Œä¸º')
                    };
                    cancelReference(mockEvent);
                    
                    // æ£€æŸ¥å¼¹æ¡†çŠ¶æ€ï¼ˆç‚¹å‡»åï¼‰
                    setTimeout(() => {
                        const drawerAfter = document.getElementById('demandDrawer');
                        const isVisibleAfter = drawerAfter && drawerAfter.classList.contains('show');
                        console.log('- ç‚¹å‡»åå¼¹æ¡†æ˜¯å¦æ˜¾ç¤º:', isVisibleAfter);
                        
                        // 4. æµ‹è¯•é‡æ–°å…³è”åŠŸèƒ½
                        setTimeout(() => {
                            console.log('æ­¥éª¤4: ç‚¹å‡»é‡æ–°å…³è”æŒ‰é’®');
                            
                            // æ£€æŸ¥å¼¹æ¡†çŠ¶æ€ï¼ˆé‡æ–°å…³è”å‰ï¼‰
                            const drawerBeforeRestore = document.getElementById('demandDrawer');
                            const isVisibleBeforeRestore = drawerBeforeRestore && drawerBeforeRestore.classList.contains('show');
                            console.log('- é‡æ–°å…³è”å‰å¼¹æ¡†æ˜¯å¦æ˜¾ç¤º:', isVisibleBeforeRestore);
                            
                            // æ¨¡æ‹Ÿç‚¹å‡»é‡æ–°å…³è”æŒ‰é’®ï¼ˆåŒ…å«äº‹ä»¶å¯¹è±¡ï¼‰
                            const mockEvent2 = {
                                stopPropagation: () => console.log('  é˜»æ­¢äº‹ä»¶å†’æ³¡'),
                                preventDefault: () => console.log('  é˜»æ­¢é»˜è®¤è¡Œä¸º')
                            };
                            restoreReference(mockEvent2);
                            
                            // æ£€æŸ¥å¼¹æ¡†çŠ¶æ€ï¼ˆé‡æ–°å…³è”åï¼‰
                            setTimeout(() => {
                                const drawerAfterRestore = document.getElementById('demandDrawer');
                                const isVisibleAfterRestore = drawerAfterRestore && drawerAfterRestore.classList.contains('show');
                                console.log('- é‡æ–°å…³è”åå¼¹æ¡†æ˜¯å¦æ˜¾ç¤º:', isVisibleAfterRestore);
                                
                                // éªŒè¯ç»“æœ
                                const allVisible = isVisibleBefore && isVisibleAfter && isVisibleBeforeRestore && isVisibleAfterRestore;
                                
                                if (allVisible) {
                                    console.log('\nâœ… æµ‹è¯•é€šè¿‡ï¼šå–æ¶ˆå‚è€ƒå’Œé‡æ–°å…³è”æŒ‰é’®éƒ½ä¸ä¼šå…³é—­å¼¹æ¡†');
                                    showNotification('âœ… ä¿®å¤æˆåŠŸï¼æŒ‰é’®ç‚¹å‡»ä¸ä¼šå…³é—­å¼¹æ¡†', 'success');
                                } else {
                                    console.log('\nâŒ æµ‹è¯•å¤±è´¥ï¼šæŒ‰é’®ç‚¹å‡»ä»ä¼šå½±å“å¼¹æ¡†æ˜¾ç¤º');
                                    showNotification('âŒ ä¿®å¤å¤±è´¥ï¼šæŒ‰é’®ç‚¹å‡»å½±å“å¼¹æ¡†æ˜¾ç¤º', 'error');
                                }
                                
                                console.log('\nğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“:');
                                console.log(`- åˆå§‹çŠ¶æ€: ${isVisibleBefore ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                                console.log(`- å–æ¶ˆå‚è€ƒå: ${isVisibleAfter ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                                console.log(`- é‡æ–°å…³è”å‰: ${isVisibleBeforeRestore ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                                console.log(`- é‡æ–°å…³è”å: ${isVisibleAfterRestore ? 'âœ… æ˜¾ç¤º' : 'âŒ éšè—'}`);
                                
                                console.log('\nğŸ”§ ä¿®å¤æ–¹æ¡ˆ:');
                                console.log('- âœ… æ·»åŠ eventå‚æ•°åˆ°cancelReferenceå’ŒrestoreReferenceå‡½æ•°');
                                console.log('- âœ… è°ƒç”¨event.stopPropagation()é˜»æ­¢äº‹ä»¶å†’æ³¡');
                                console.log('- âœ… è°ƒç”¨event.preventDefault()é˜»æ­¢é»˜è®¤è¡Œä¸º');
                                console.log('- âœ… ç¡®ä¿ç”¨æˆ·åœ¨ç‚¹å‡»æŒ‰é’®åç»§ç»­ç•™åœ¨æ–°å¢éœ€æ±‚å¼¹æ¡†å†…');
                            }, 300);
                        }, 2000);
                    }, 300);
                }, 2000);
            }, 1000);
        };
    </script>
</body>
</html>